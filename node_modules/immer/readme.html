<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>readme</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<p><img src="images/immer-logo.png" height="200px" align="right"/></p>
<h1 id="immer">Immer</h1>
<p><a href="https://www.npmjs.com/package/immer"><img src="https://img.shields.io/npm/v/immer.svg" alt="npm" /></a> <a href="http://img.badgesize.io/https://cdn.jsdelivr.net/npm/immer/dist/immer.umd.js"><embed src="http://img.badgesize.io/https://cdn.jsdelivr.net/npm/immer/dist/immer.umd.js?compression=gzip" /></a> <a href="https://packagephobia.now.sh/result?p=immer"><img src="https://packagephobia.now.sh/badge?p=immer" alt="install size" /></a> <a href="https://travis-ci.org/mweststrate/immer"><img src="https://travis-ci.org/mweststrate/immer.svg?branch=master" alt="Build Status" /></a> <a href="https://coveralls.io/github/mweststrate/immer?branch=master"><img src="https://coveralls.io/repos/github/mweststrate/immer/badge.svg?branch=master" alt="Coverage Status" /></a> <a href="https://github.com/prettier/prettier"><img src="https://img.shields.io/badge/code_style-prettier-ff69b4.svg" alt="code style: prettier" /></a> <a href="https://www.paypal.me/michelweststrate"><img src="https://img.shields.io/badge/Donate-PayPal-green.svg" alt="Donate" /></a></p>
<p><em>Create the next immutable state tree by simply modifying the current tree</em></p>
<h3 id="release-notes"><a href="https://github.com/mweststrate/immer/releases">Release notes</a></h3>
<p>Did Immer make a difference to your project? Consider buying me a coffee!<br/><a href="https://www.buymeacoffee.com/mweststrate" target="_blank"><img src="https://www.buymeacoffee.com/assets/img/custom_images/orange_img.png" alt="Buy Me A Coffee" style="height: auto !important;width: auto !important;" ></a></p>
<hr />
<ul>
<li>NPM: <code>npm install immer</code></li>
<li>Yarn: <code>yarn add immer</code></li>
<li>CDN: Exposed global is <code>immer</code>
<ul>
<li>Unpkg: <code>&lt;script src="https://unpkg.com/immer/dist/immer.umd.js"&gt;&lt;/script&gt;</code></li>
<li>JSDelivr: <code>&lt;script src="https://cdn.jsdelivr.net/npm/immer/dist/immer.umd.js"&gt;&lt;/script&gt;</code></li>
</ul></li>
</ul>
<hr />
<ul>
<li>Egghead lesson covering all of immer (7m): <a href="https://egghead.io/lessons/redux-simplify-creating-immutable-data-trees-with-immer">Simplify creating immutable data trees with Immer</a></li>
<li>Introduction blogpost: <a href="https://medium.com/@mweststrate/introducing-immer-immutability-the-easy-way-9d73d8f71cb3">Immer: Immutability the easy way</a></li>
</ul>
<p>Immer (German for: always) is a tiny package that allows you to work with immutable state in a more convenient way. It is based on the <a href="https://en.wikipedia.org/wiki/Copy-on-write"><em>copy-on-write</em></a> mechanism.</p>
<p>The basic idea is that you will apply all your changes to a temporarily <em>draftState</em>, which is a proxy of the <em>currentState</em>. Once all your mutations are completed, Immer will produce the <em>nextState</em> based on the mutations to the draft state. This means that you can interact with your data by simply modifying it while keeping all the benefits of immutable data.</p>
<figure>
<img src="images/hd/immer.png" alt="immer-hd.png" /><figcaption>immer-hd.png</figcaption>
</figure>
<p>Using Immer is like having a personal assistant; he takes a letter (the current state) and gives you a copy (draft) to jot changes onto. Once you are done, the assistant will take your draft and produce the real immutable, final letter for you (the next state).</p>
<p>A mindful reader might notice that this is quite similar to <code>withMutations</code> of ImmutableJS. It is indeed, but generalized and applied to plain, native JavaScript data structures (arrays and objects) without further needing any library.</p>
<h2 id="external-resources">External resources</h2>
<ul>
<li>Blog: <a href="https://www.netlify.com/blog/2018/09/12/the-rise-of-immer-in-react/">The Rise of Immer in React</a></li>
<li>Blog: by Workday Prism on why they picked Immer to manage immutable state <a href="https://medium.com/workday-engineering/workday-prism-analytics-the-search-for-a-strongly-typed-immutable-state-a09f6768b2b5">The Search for a Strongly-Typed, Immutable State</a></li>
<li>Blog: <a href="https://daveceddia.com/react-redux-immutability-guide/">Immutability in React and Redux: The Complete Guide</a></li>
<li>Video tutorial: <a href="https://codedaily.io/screencasts/86/Immutable-Data-with-Immer-and-React-setState">Using Immer with React.setState</a></li>
<li><a href="https://www.youtube.com/watch?v=-gJbS7YjcSo">Talk</a> + <a href="http://immer.surge.sh/">slides</a> on Immer at React Finland 2018 by Michel Weststrate</li>
</ul>
<h2 id="api">API</h2>
<p>The Immer package exposes a default function that does all the work.</p>
<p><code>produce(currentState, producer: (draftState) =&gt; void): nextState</code></p>
<p>There is also a curried overload that is explained <a href="#currying">below</a>.</p>
<h2 id="example">Example</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="im">import</span> produce <span class="im">from</span> <span class="st">&quot;immer&quot;</span></a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">const</span> baseState <span class="op">=</span> [</a>
<a class="sourceLine" id="cb1-4" title="4">    <span class="op">{</span></a>
<a class="sourceLine" id="cb1-5" title="5">        <span class="dt">todo</span><span class="op">:</span> <span class="st">&quot;Learn typescript&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb1-6" title="6">        <span class="dt">done</span><span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb1-7" title="7">    <span class="op">},</span></a>
<a class="sourceLine" id="cb1-8" title="8">    <span class="op">{</span></a>
<a class="sourceLine" id="cb1-9" title="9">        <span class="dt">todo</span><span class="op">:</span> <span class="st">&quot;Try immer&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb1-10" title="10">        <span class="dt">done</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb1-11" title="11">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-12" title="12">]</a>
<a class="sourceLine" id="cb1-13" title="13"></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="kw">const</span> nextState <span class="op">=</span> <span class="at">produce</span>(baseState<span class="op">,</span> draftState <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-15" title="15">    <span class="va">draftState</span>.<span class="at">push</span>(<span class="op">{</span><span class="dt">todo</span><span class="op">:</span> <span class="st">&quot;Tweet about it&quot;</span><span class="op">}</span>)</a>
<a class="sourceLine" id="cb1-16" title="16">    draftState[<span class="dv">1</span>].<span class="at">done</span> <span class="op">=</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="op">}</span>)</a></code></pre></div>
<p>The interesting thing about Immer is that the <code>baseState</code> will be untouched, but the <code>nextState</code> will reflect all changes made to <code>draftState</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="co">// the new item is only added to the next state,</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co">// base state is unmodified</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="at">expect</span>(<span class="va">baseState</span>.<span class="at">length</span>).<span class="at">toBe</span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb2-4" title="4"><span class="at">expect</span>(<span class="va">nextState</span>.<span class="at">length</span>).<span class="at">toBe</span>(<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb2-5" title="5"></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="co">// same for the changed &#39;done&#39; prop</span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="at">expect</span>(baseState[<span class="dv">1</span>].<span class="at">done</span>).<span class="at">toBe</span>(<span class="kw">false</span>)</a>
<a class="sourceLine" id="cb2-8" title="8"><span class="at">expect</span>(nextState[<span class="dv">1</span>].<span class="at">done</span>).<span class="at">toBe</span>(<span class="kw">true</span>)</a>
<a class="sourceLine" id="cb2-9" title="9"></a>
<a class="sourceLine" id="cb2-10" title="10"><span class="co">// unchanged data is structurally shared</span></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="at">expect</span>(nextState[<span class="dv">0</span>]).<span class="at">toBe</span>(baseState[<span class="dv">0</span>])</a>
<a class="sourceLine" id="cb2-12" title="12"><span class="co">// changed data not (dûh)</span></a>
<a class="sourceLine" id="cb2-13" title="13"><span class="at">expect</span>(nextState[<span class="dv">1</span>]).<span class="va">not</span>.<span class="at">toBe</span>(baseState[<span class="dv">1</span>])</a></code></pre></div>
<h2 id="benefits">Benefits</h2>
<ul>
<li>Immutability with normal JavaScript objects and arrays. No new APIs to learn!</li>
<li>Strongly typed, no string based paths selectors etc.</li>
<li>Structural sharing out of the box</li>
<li>Object freezing out of the box</li>
<li>Deep updates are a breeze</li>
<li>Boilerplate reduction. Less noise, more concise code.</li>
<li>Small: bundled and minified: 2KB.</li>
</ul>
<p>Read further to see all these benefits explained.</p>
<h2 id="reducer-example">Reducer Example</h2>
<p>Here is a simple example of the difference that Immer could make in practice.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="co">// Redux reducer</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="co">// Shortened, based on: https://github.com/reactjs/redux/blob/master/examples/shopping-cart/src/reducers/products.js</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">const</span> byId <span class="op">=</span> (state<span class="op">,</span> action) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-4" title="4">    <span class="cf">switch</span> (<span class="va">action</span>.<span class="at">type</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-5" title="5">        <span class="cf">case</span> <span class="dt">RECEIVE_PRODUCTS</span><span class="op">:</span></a>
<a class="sourceLine" id="cb3-6" title="6">            <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-7" title="7">                ...<span class="at">state</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-8" title="8">                ...<span class="va">action</span>.<span class="va">products</span>.<span class="at">reduce</span>((obj<span class="op">,</span> product) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-9" title="9">                    obj[<span class="va">product</span>.<span class="at">id</span>] <span class="op">=</span> product</a>
<a class="sourceLine" id="cb3-10" title="10">                    <span class="cf">return</span> obj</a>
<a class="sourceLine" id="cb3-11" title="11">                <span class="op">},</span> <span class="op">{}</span>)</a>
<a class="sourceLine" id="cb3-12" title="12">            <span class="op">}</span></a>
<a class="sourceLine" id="cb3-13" title="13">        <span class="cf">default</span><span class="op">:</span></a>
<a class="sourceLine" id="cb3-14" title="14">            <span class="cf">return</span> state</a>
<a class="sourceLine" id="cb3-15" title="15">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="op">}</span></a></code></pre></div>
<p>After using Immer, that simply becomes:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="im">import</span> produce <span class="im">from</span> <span class="st">&quot;immer&quot;</span></a>
<a class="sourceLine" id="cb4-2" title="2"></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw">const</span> byId <span class="op">=</span> (state<span class="op">,</span> action) <span class="kw">=&gt;</span></a>
<a class="sourceLine" id="cb4-4" title="4">    <span class="at">produce</span>(state<span class="op">,</span> draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-5" title="5">        <span class="cf">switch</span> (<span class="va">action</span>.<span class="at">type</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-6" title="6">            <span class="cf">case</span> <span class="dt">RECEIVE_PRODUCTS</span><span class="op">:</span></a>
<a class="sourceLine" id="cb4-7" title="7">                <span class="va">action</span>.<span class="va">products</span>.<span class="at">forEach</span>(product <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-8" title="8">                    draft[<span class="va">product</span>.<span class="at">id</span>] <span class="op">=</span> product</a>
<a class="sourceLine" id="cb4-9" title="9">                <span class="op">}</span>)</a>
<a class="sourceLine" id="cb4-10" title="10">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-11" title="11">    <span class="op">}</span>)</a></code></pre></div>
<p>Notice that it is not needed to handle the default case, a producer that doesn’t do anything will simply return the original state.</p>
<p>Creating Redux reducer is just a sample application of the Immer package. Immer is not just designed to simplify Redux reducers. It can be used in any context where you have an immutable data tree that you want to clone and modify (with structural sharing).</p>
<p><em>Note: it might be tempting after using producers for a while, to just place <code>produce</code> in your root reducer and then pass the draft to each reducer and work directly over such draft. Don’t do that. It kills the point of Redux where each reducer is testable as pure reducer. Immer is best used when applying it to small individual pieces of logic.</em></p>
<h2 id="react.setstate-example">React.setState example</h2>
<p>Deep updates in the state of React components can be greatly simplified as well by using immer. Take for example the following onClick handlers (Try in <a href="https://codesandbox.io/s/m4yp57632j">codesandbox</a>):</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="co">/**</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="co"> * Classic React.setState with a deep merge</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="co"> */</span></a>
<a class="sourceLine" id="cb5-4" title="4">onBirthDayClick1 <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="kw">this</span>.<span class="at">setState</span>(prevState <span class="kw">=&gt;</span> (<span class="op">{</span></a>
<a class="sourceLine" id="cb5-6" title="6">        <span class="dt">user</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-7" title="7">            ...<span class="va">prevState</span>.<span class="at">user</span><span class="op">,</span></a>
<a class="sourceLine" id="cb5-8" title="8">            <span class="dt">age</span><span class="op">:</span> <span class="va">prevState</span>.<span class="va">user</span>.<span class="at">age</span> <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb5-9" title="9">        <span class="op">}</span></a>
<a class="sourceLine" id="cb5-10" title="10">    <span class="op">}</span>))</a>
<a class="sourceLine" id="cb5-11" title="11"><span class="op">}</span></a>
<a class="sourceLine" id="cb5-12" title="12"></a>
<a class="sourceLine" id="cb5-13" title="13"><span class="co">/**</span></a>
<a class="sourceLine" id="cb5-14" title="14"><span class="co"> * ...But, since setState accepts functions,</span></a>
<a class="sourceLine" id="cb5-15" title="15"><span class="co"> * we can just create a curried producer and further simplify!</span></a>
<a class="sourceLine" id="cb5-16" title="16"><span class="co"> */</span></a>
<a class="sourceLine" id="cb5-17" title="17">onBirthDayClick2 <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-18" title="18">    <span class="kw">this</span>.<span class="at">setState</span>(</a>
<a class="sourceLine" id="cb5-19" title="19">        <span class="at">produce</span>(draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-20" title="20">            <span class="va">draft</span>.<span class="va">user</span>.<span class="at">age</span> <span class="op">+=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb5-21" title="21">        <span class="op">}</span>)</a>
<a class="sourceLine" id="cb5-22" title="22">    )</a>
<a class="sourceLine" id="cb5-23" title="23"><span class="op">}</span></a></code></pre></div>
<h2 id="currying">Currying</h2>
<p>Passing a function as the first argument to <code>produce</code> is intended to be used for currying. This means that you get a pre-bound producer that only needs a state to produce the value from. The producer function gets passed in the draft and any further arguments that were passed to the curried function.</p>
<p>For example:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="co">// mapper will be of signature (state, index) =&gt; state</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="kw">const</span> mapper <span class="op">=</span> <span class="at">produce</span>((draft<span class="op">,</span> index) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-3" title="3">    <span class="va">draft</span>.<span class="at">index</span> <span class="op">=</span> index</a>
<a class="sourceLine" id="cb6-4" title="4"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb6-5" title="5"></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="co">// example usage</span></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="va">console</span>.<span class="at">dir</span>([<span class="op">{},</span> <span class="op">{},</span> <span class="op">{}</span>].<span class="at">map</span>(mapper))</a>
<a class="sourceLine" id="cb6-8" title="8"><span class="co">//[{index: 0}, {index: 1}, {index: 2}])</span></a></code></pre></div>
<p>This mechanism can also nicely be leveraged to further simplify our example reducer:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="im">import</span> produce <span class="im">from</span> <span class="st">&#39;immer&#39;</span></a>
<a class="sourceLine" id="cb7-2" title="2"></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="kw">const</span> byId <span class="op">=</span> <span class="at">produce</span>((draft<span class="op">,</span> action) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-4" title="4">  <span class="cf">switch</span> (<span class="va">action</span>.<span class="at">type</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-5" title="5">    <span class="cf">case</span> <span class="dt">RECEIVE_PRODUCTS</span><span class="op">:</span></a>
<a class="sourceLine" id="cb7-6" title="6">      <span class="va">action</span>.<span class="va">products</span>.<span class="at">forEach</span>(product <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-7" title="7">        draft[<span class="va">product</span>.<span class="at">id</span>] <span class="op">=</span> product</a>
<a class="sourceLine" id="cb7-8" title="8">      <span class="op">}</span>)</a>
<a class="sourceLine" id="cb7-9" title="9">      <span class="cf">return</span></a>
<a class="sourceLine" id="cb7-10" title="10">    <span class="op">}</span>)</a>
<a class="sourceLine" id="cb7-11" title="11">  <span class="op">}</span></a>
<a class="sourceLine" id="cb7-12" title="12">})</a></code></pre></div>
<p>Note that <code>state</code> is now factored out (the created reducer will accept a state, and invoke the bound producer with it).</p>
<p>If you want to initialize an uninitialized state using this construction, you can do so by passing the initial state as second argument to <code>produce</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="im">import</span> produce <span class="im">from</span> <span class="st">&quot;immer&quot;</span></a>
<a class="sourceLine" id="cb8-2" title="2"></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="kw">const</span> byId <span class="op">=</span> <span class="at">produce</span>(</a>
<a class="sourceLine" id="cb8-4" title="4">    (draft<span class="op">,</span> action) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-5" title="5">        <span class="cf">switch</span> (<span class="va">action</span>.<span class="at">type</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-6" title="6">            <span class="cf">case</span> <span class="dt">RECEIVE_PRODUCTS</span><span class="op">:</span></a>
<a class="sourceLine" id="cb8-7" title="7">                <span class="va">action</span>.<span class="va">products</span>.<span class="at">forEach</span>(product <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-8" title="8">                    draft[<span class="va">product</span>.<span class="at">id</span>] <span class="op">=</span> product</a>
<a class="sourceLine" id="cb8-9" title="9">                <span class="op">}</span>)</a>
<a class="sourceLine" id="cb8-10" title="10">                <span class="cf">return</span></a>
<a class="sourceLine" id="cb8-11" title="11">        <span class="op">}</span></a>
<a class="sourceLine" id="cb8-12" title="12">    <span class="op">},</span></a>
<a class="sourceLine" id="cb8-13" title="13">    <span class="op">{</span></a>
<a class="sourceLine" id="cb8-14" title="14">        <span class="dv">1</span><span class="op">:</span> <span class="op">{</span><span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&quot;product-1&quot;</span><span class="op">}</span></a>
<a class="sourceLine" id="cb8-15" title="15">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-16" title="16">)</a></code></pre></div>
<h5 id="fun-with-currying">Fun with currying</h5>
<p>A random fun example just for inspiration: a neat trick is to turn <code>Object.assign</code> into a producer to create a “spread” function that is smarter than the normal spread operator, as it doesn’t produce a new state if the result doesn’t actually change (<a href="https://twitter.com/mweststrate/status/1045059430256119809">details &amp; explanation</a>). Quick example:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="im">import</span> produce <span class="im">from</span> <span class="st">&quot;immer&quot;</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="kw">const</span> spread <span class="op">=</span> <span class="at">produce</span>(<span class="va">Object</span>.<span class="at">assign</span>)</a>
<a class="sourceLine" id="cb9-3" title="3"></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="kw">const</span> base <span class="op">=</span> <span class="op">{</span><span class="dt">x</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="dv">1</span><span class="op">}</span></a>
<a class="sourceLine" id="cb9-5" title="5"></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="va">console</span>.<span class="at">log</span>(<span class="op">{</span>...<span class="at">base</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="dv">1</span><span class="op">}</span> <span class="op">===</span> base) <span class="co">// false</span></a>
<a class="sourceLine" id="cb9-7" title="7"><span class="va">console</span>.<span class="at">log</span>(<span class="at">spread</span>(base<span class="op">,</span> <span class="op">{</span><span class="dt">y</span><span class="op">:</span> <span class="dv">1</span><span class="op">}</span>) <span class="op">===</span> base) <span class="co">// true! base is recycled as no actual new value was produced</span></a>
<a class="sourceLine" id="cb9-8" title="8"><span class="va">console</span>.<span class="at">log</span>(<span class="at">spread</span>(base<span class="op">,</span> <span class="op">{</span><span class="dt">y</span><span class="op">:</span> <span class="dv">2</span><span class="op">}</span>) <span class="op">===</span> base) <span class="co">// false, produced a new object as it should</span></a></code></pre></div>
<h2 id="patches">Patches</h2>
<p>During the run of a producer, Immer can record all the patches that would replay the changes made by the reducer. This is a very powerful tool if you want to fork your state temporarily and replay the changes to the original.</p>
<p>Patches are useful in few scenarios:</p>
<ul>
<li>To exchange incremental updates with other parties, for example over websockets</li>
<li>For debugging / traces, to see precisely how state is changed over time</li>
<li>As basis for undo/redo or as an approach to replay changes on a slightly different state tree</li>
</ul>
<p>To help with replaying patches, <code>applyPatches</code> comes in handy. Here is an example how patches could be used to record the incremental updates and (inverse) apply them:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="im">import</span> produce<span class="op">,</span> <span class="op">{</span>applyPatches<span class="op">}</span> <span class="im">from</span> <span class="st">&quot;immer&quot;</span></a>
<a class="sourceLine" id="cb10-2" title="2"></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="kw">let</span> state <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-4" title="4">    <span class="dt">name</span><span class="op">:</span> <span class="st">&quot;Micheal&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb10-5" title="5">    <span class="dt">age</span><span class="op">:</span> <span class="dv">32</span></a>
<a class="sourceLine" id="cb10-6" title="6"><span class="op">}</span></a>
<a class="sourceLine" id="cb10-7" title="7"></a>
<a class="sourceLine" id="cb10-8" title="8"><span class="co">// Let&#39;s assume the user is in a wizard, and we don&#39;t know whether</span></a>
<a class="sourceLine" id="cb10-9" title="9"><span class="co">// his changes should end up in the base state ultimately or not...</span></a>
<a class="sourceLine" id="cb10-10" title="10"><span class="kw">let</span> fork <span class="op">=</span> state</a>
<a class="sourceLine" id="cb10-11" title="11"><span class="co">// all the changes the user made in the wizard</span></a>
<a class="sourceLine" id="cb10-12" title="12"><span class="kw">let</span> changes <span class="op">=</span> []</a>
<a class="sourceLine" id="cb10-13" title="13"><span class="co">// the inverse of all the changes made in the wizard</span></a>
<a class="sourceLine" id="cb10-14" title="14"><span class="kw">let</span> inverseChanges <span class="op">=</span> []</a>
<a class="sourceLine" id="cb10-15" title="15"></a>
<a class="sourceLine" id="cb10-16" title="16">fork <span class="op">=</span> <span class="at">produce</span>(</a>
<a class="sourceLine" id="cb10-17" title="17">    fork<span class="op">,</span></a>
<a class="sourceLine" id="cb10-18" title="18">    draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-19" title="19">        <span class="va">draft</span>.<span class="at">age</span> <span class="op">=</span> <span class="dv">33</span></a>
<a class="sourceLine" id="cb10-20" title="20">    <span class="op">},</span></a>
<a class="sourceLine" id="cb10-21" title="21">    <span class="co">// The third argument to produce is a callback to which the patches will be fed</span></a>
<a class="sourceLine" id="cb10-22" title="22">    (patches<span class="op">,</span> inversePatches) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-23" title="23">        <span class="va">changes</span>.<span class="at">push</span>(...<span class="at">patches</span>)</a>
<a class="sourceLine" id="cb10-24" title="24">        <span class="va">inverseChanges</span>.<span class="at">push</span>(...<span class="at">inversePatches</span>)</a>
<a class="sourceLine" id="cb10-25" title="25">    <span class="op">}</span></a>
<a class="sourceLine" id="cb10-26" title="26">)</a>
<a class="sourceLine" id="cb10-27" title="27"></a>
<a class="sourceLine" id="cb10-28" title="28"><span class="co">// In the meantime, our original state is replaced, as, for example,</span></a>
<a class="sourceLine" id="cb10-29" title="29"><span class="co">// some changes were received from the server</span></a>
<a class="sourceLine" id="cb10-30" title="30">state <span class="op">=</span> <span class="at">produce</span>(state<span class="op">,</span> draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-31" title="31">    <span class="va">draft</span>.<span class="at">name</span> <span class="op">=</span> <span class="st">&quot;Michel&quot;</span></a>
<a class="sourceLine" id="cb10-32" title="32"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb10-33" title="33"></a>
<a class="sourceLine" id="cb10-34" title="34"><span class="co">// When the wizard finishes (successfully) we can replay the changes that were in the fork onto the *new* state!</span></a>
<a class="sourceLine" id="cb10-35" title="35">state <span class="op">=</span> <span class="at">applyPatches</span>(state<span class="op">,</span> changes)</a>
<a class="sourceLine" id="cb10-36" title="36"></a>
<a class="sourceLine" id="cb10-37" title="37"><span class="co">// state now contains the changes from both code paths!</span></a>
<a class="sourceLine" id="cb10-38" title="38"><span class="at">expect</span>(state).<span class="at">toEqual</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb10-39" title="39">    <span class="dt">name</span><span class="op">:</span> <span class="st">&quot;Michel&quot;</span><span class="op">,</span> <span class="co">// changed by the server</span></a>
<a class="sourceLine" id="cb10-40" title="40">    <span class="dt">age</span><span class="op">:</span> <span class="dv">33</span> <span class="co">// changed by the wizard</span></a>
<a class="sourceLine" id="cb10-41" title="41"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb10-42" title="42"></a>
<a class="sourceLine" id="cb10-43" title="43"><span class="co">// Finally, even after finishing the wizard, the user might change his mind and undo his changes...</span></a>
<a class="sourceLine" id="cb10-44" title="44">state <span class="op">=</span> <span class="at">applyPatches</span>(state<span class="op">,</span> inverseChanges)</a>
<a class="sourceLine" id="cb10-45" title="45"><span class="at">expect</span>(state).<span class="at">toEqual</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb10-46" title="46">    <span class="dt">name</span><span class="op">:</span> <span class="st">&quot;Michel&quot;</span><span class="op">,</span> <span class="co">// Not reverted</span></a>
<a class="sourceLine" id="cb10-47" title="47">    <span class="dt">age</span><span class="op">:</span> <span class="dv">32</span> <span class="co">// Reverted</span></a>
<a class="sourceLine" id="cb10-48" title="48"><span class="op">}</span>)</a></code></pre></div>
<p>The generated patches are similar (but not the same) to the <a href="http://tools.ietf.org/html/rfc6902">RFC-6902 JSON patch standard</a>, except that the <code>path</code> property is an array, rather than a string. This makes processing patches easier. If you want to normalize to the official specification, <code>patch.path = patch.path.join("/")</code> should do the trick. Anyway, this is what a bunch of patches and their inverse could look like:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb11-1" title="1"><span class="ot">[</span></a>
<a class="sourceLine" id="cb11-2" title="2">    <span class="fu">{</span></a>
<a class="sourceLine" id="cb11-3" title="3">        <span class="dt">&quot;op&quot;</span><span class="fu">:</span> <span class="st">&quot;replace&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb11-4" title="4">        <span class="dt">&quot;path&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;profile&quot;</span><span class="ot">]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb11-5" title="5">        <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;Veria&quot;</span><span class="fu">,</span> <span class="dt">&quot;age&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">}</span></a>
<a class="sourceLine" id="cb11-6" title="6">    <span class="fu">}</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb11-7" title="7">    <span class="fu">{</span><span class="dt">&quot;op&quot;</span><span class="fu">:</span> <span class="st">&quot;remove&quot;</span><span class="fu">,</span> <span class="dt">&quot;path&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;tags&quot;</span><span class="ot">,</span> <span class="dv">3</span><span class="ot">]</span><span class="fu">}</span></a>
<a class="sourceLine" id="cb11-8" title="8"><span class="ot">]</span></a></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb12-1" title="1"><span class="ot">[</span></a>
<a class="sourceLine" id="cb12-2" title="2">    <span class="fu">{</span><span class="dt">&quot;op&quot;</span><span class="fu">:</span> <span class="st">&quot;replace&quot;</span><span class="fu">,</span> <span class="dt">&quot;path&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;profile&quot;</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;Noa&quot;</span><span class="fu">,</span> <span class="dt">&quot;age&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">}}</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb12-3" title="3">    <span class="fu">{</span><span class="dt">&quot;op&quot;</span><span class="fu">:</span> <span class="st">&quot;add&quot;</span><span class="fu">,</span> <span class="dt">&quot;path&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;tags&quot;</span><span class="ot">,</span> <span class="dv">3</span><span class="ot">]</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="st">&quot;kiddo&quot;</span><span class="fu">}</span></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="ot">]</span></a></code></pre></div>
<p>For a more in-depth study, see <a href="https://medium.com/@mweststrate/distributing-state-changes-using-snapshots-patches-and-actions-part-2-2f50d8363988">Distributing patches and rebasing actions using Immer</a></p>
<p>Tip: Check this trick to <a href="https://medium.com/@david.b.edelstein/using-immer-to-compress-immer-patches-f382835b6c69">compress patches</a> produced over time.</p>
<h2 id="auto-freezing">Auto freezing</h2>
<p>Immer automatically freezes any state trees that are modified using <code>produce</code>. This protects against accidental modifications of the state tree outside of a producer. This comes with a performance impact, so it is recommended to disable this option in production. It is by default enabled. By default, it is turned on during local development and turned off in production. Use <code>setAutoFreeze(true / false)</code> to explicitly turn this feature on or off.</p>
<h2 id="returning-data-from-producers">Returning data from producers</h2>
<p>It is not needed to return anything from a producer, as Immer will return the (finalized) version of the <code>draft</code> anyway. However, it is allowed to just <code>return draft</code>.</p>
<p>It is also allowed to return arbitrarily other data from the producer function. But <em>only</em> if you didn’t modify the draft. This can be useful to produce an entirely new state. Some examples:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">const</span> userReducer <span class="op">=</span> <span class="at">produce</span>((draft<span class="op">,</span> action) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-2" title="2">    <span class="cf">switch</span> (<span class="va">action</span>.<span class="at">type</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-3" title="3">        <span class="cf">case</span> <span class="st">&quot;renameUser&quot;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb13-4" title="4">            <span class="co">// OK: we modify the current state</span></a>
<a class="sourceLine" id="cb13-5" title="5">            <span class="va">draft</span>.<span class="at">users</span>[<span class="va">action</span>.<span class="va">payload</span>.<span class="at">id</span>].<span class="at">name</span> <span class="op">=</span> <span class="va">action</span>.<span class="va">payload</span>.<span class="at">name</span></a>
<a class="sourceLine" id="cb13-6" title="6">            <span class="cf">return</span> draft <span class="co">// same as just &#39;return&#39;</span></a>
<a class="sourceLine" id="cb13-7" title="7">        <span class="cf">case</span> <span class="st">&quot;loadUsers&quot;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb13-8" title="8">            <span class="co">// OK: we return an entirely new state</span></a>
<a class="sourceLine" id="cb13-9" title="9">            <span class="cf">return</span> <span class="va">action</span>.<span class="at">payload</span></a>
<a class="sourceLine" id="cb13-10" title="10">        <span class="cf">case</span> <span class="st">&quot;adduser-1&quot;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb13-11" title="11">            <span class="co">// NOT OK: This doesn&#39;t do change the draft nor return a new state!</span></a>
<a class="sourceLine" id="cb13-12" title="12">            <span class="co">// It doesn&#39;t modify the draft (it just redeclares it)</span></a>
<a class="sourceLine" id="cb13-13" title="13">            <span class="co">// In fact, this just doesn&#39;t do anything at all</span></a>
<a class="sourceLine" id="cb13-14" title="14">            draft <span class="op">=</span> <span class="op">{</span><span class="dt">users</span><span class="op">:</span> [...<span class="va">draft</span>.<span class="at">users</span><span class="op">,</span> <span class="va">action</span>.<span class="at">payload</span>]<span class="op">}</span></a>
<a class="sourceLine" id="cb13-15" title="15">            <span class="cf">return</span></a>
<a class="sourceLine" id="cb13-16" title="16">        <span class="cf">case</span> <span class="st">&quot;adduser-2&quot;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb13-17" title="17">            <span class="co">// NOT OK: modifying draft *and* returning a new state</span></a>
<a class="sourceLine" id="cb13-18" title="18">            <span class="va">draft</span>.<span class="at">userCount</span> <span class="op">+=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb13-19" title="19">            <span class="cf">return</span> <span class="op">{</span><span class="dt">users</span><span class="op">:</span> [...<span class="va">draft</span>.<span class="at">users</span><span class="op">,</span> <span class="va">action</span>.<span class="at">payload</span>]<span class="op">}</span></a>
<a class="sourceLine" id="cb13-20" title="20">        <span class="cf">case</span> <span class="st">&quot;adduser-3&quot;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb13-21" title="21">            <span class="co">// OK: returning a new state. But, unnecessary complex and expensive</span></a>
<a class="sourceLine" id="cb13-22" title="22">            <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-23" title="23">                <span class="dt">userCount</span><span class="op">:</span> <span class="va">draft</span>.<span class="at">userCount</span> <span class="op">+</span> <span class="dv">1</span><span class="op">,</span></a>
<a class="sourceLine" id="cb13-24" title="24">                <span class="dt">users</span><span class="op">:</span> [...<span class="va">draft</span>.<span class="at">users</span><span class="op">,</span> <span class="va">action</span>.<span class="at">payload</span>]</a>
<a class="sourceLine" id="cb13-25" title="25">            <span class="op">}</span></a>
<a class="sourceLine" id="cb13-26" title="26">        <span class="cf">case</span> <span class="st">&quot;adduser-4&quot;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb13-27" title="27">            <span class="co">// OK: the immer way</span></a>
<a class="sourceLine" id="cb13-28" title="28">            <span class="va">draft</span>.<span class="at">userCount</span> <span class="op">+=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb13-29" title="29">            <span class="va">draft</span>.<span class="va">users</span>.<span class="at">push</span>(<span class="va">action</span>.<span class="at">payload</span>)</a>
<a class="sourceLine" id="cb13-30" title="30">            <span class="cf">return</span></a>
<a class="sourceLine" id="cb13-31" title="31">    <span class="op">}</span></a>
<a class="sourceLine" id="cb13-32" title="32"><span class="op">}</span>)</a></code></pre></div>
<p><em>Note: It is not possible to return <code>undefined</code> this way, as it is indistinguishable from <em>not</em> updating the draft! Read on…</em></p>
<h2 id="producing-undefined-using-nothing">Producing <code>undefined</code> using <code>nothing</code></h2>
<p>So, in general, one can replace the current state by just <code>return</code>ing a new value from the producer, rather than modifying the draft. There is a subtle edge case however: if you try to write a producer that wants to replace the current state with <code>undefined</code>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb14-1" title="1"><span class="at">produce</span>(<span class="op">{},</span> draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-2" title="2">    <span class="co">// don&#39;t do anything</span></a>
<a class="sourceLine" id="cb14-3" title="3"><span class="op">}</span>)</a></code></pre></div>
<p>Versus:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb15-1" title="1"><span class="at">produce</span>(<span class="op">{},</span> draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-2" title="2">    <span class="co">// Try to return undefined from the producer</span></a>
<a class="sourceLine" id="cb15-3" title="3">    <span class="cf">return</span> <span class="kw">undefined</span></a>
<a class="sourceLine" id="cb15-4" title="4"><span class="op">}</span>)</a></code></pre></div>
<p>The problem is that in JavaScript a function that doesn’t return anything also returns <code>undefined</code>! So immer cannot differentiate between those different cases. So, by default, Immer will assume that any producer that returns <code>undefined</code> just tried to modify the draft.</p>
<p>However, to make it clear to Immer that you intentionally want to produce the value <code>undefined</code>, you can return the built-in token <code>nothing</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb16-1" title="1"><span class="im">import</span> produce<span class="op">,</span> <span class="op">{</span>nothing<span class="op">}</span> <span class="im">from</span> <span class="st">&quot;immer&quot;</span></a>
<a class="sourceLine" id="cb16-2" title="2"></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="kw">const</span> state <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb16-4" title="4">    <span class="dt">hello</span><span class="op">:</span> <span class="st">&quot;world&quot;</span></a>
<a class="sourceLine" id="cb16-5" title="5"><span class="op">}</span></a>
<a class="sourceLine" id="cb16-6" title="6"></a>
<a class="sourceLine" id="cb16-7" title="7"><span class="at">produce</span>(state<span class="op">,</span> draft <span class="kw">=&gt;</span> <span class="op">{}</span>)</a>
<a class="sourceLine" id="cb16-8" title="8"><span class="at">produce</span>(state<span class="op">,</span> draft <span class="kw">=&gt;</span> <span class="kw">undefined</span>)</a>
<a class="sourceLine" id="cb16-9" title="9"><span class="co">// Both return the original state: { hello: &quot;world&quot;}</span></a>
<a class="sourceLine" id="cb16-10" title="10"></a>
<a class="sourceLine" id="cb16-11" title="11"><span class="at">produce</span>(state<span class="op">,</span> draft <span class="kw">=&gt;</span> nothing)</a>
<a class="sourceLine" id="cb16-12" title="12"><span class="co">// Produces a new state, &#39;undefined&#39;</span></a></code></pre></div>
<p>N.B. Note that this problem is specific for the <code>undefined</code> value, any other value, including <code>null</code>, doesn’t suffer from this issue.</p>
<h2 id="extracting-the-original-object-from-a-proxied-instance">Extracting the original object from a proxied instance</h2>
<p>Immer exposes a named export <code>original</code> that will get the original object from the proxied instance inside <code>produce</code> (or return <code>undefined</code> for unproxied values). A good example of when this can be useful is when searching for nodes in a tree-like state using strict equality.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">const</span> baseState <span class="op">=</span> <span class="op">{</span><span class="dt">users</span><span class="op">:</span> [<span class="op">{</span><span class="dt">name</span><span class="op">:</span> <span class="st">&quot;Richie&quot;</span><span class="op">}</span>]<span class="op">}</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="kw">const</span> nextState <span class="op">=</span> <span class="at">produce</span>(baseState<span class="op">,</span> draftState <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb17-3" title="3">    <span class="at">original</span>(<span class="va">draftState</span>.<span class="at">users</span>) <span class="co">// is === baseState.users</span></a>
<a class="sourceLine" id="cb17-4" title="4"><span class="op">}</span>)</a></code></pre></div>
<p>Just want to know if a value is a proxied instance? Use the <code>isDraft</code> function!</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb18-1" title="1"><span class="im">import</span> <span class="op">{</span>isDraft<span class="op">}</span> <span class="im">from</span> <span class="st">&quot;immer&quot;</span></a>
<a class="sourceLine" id="cb18-2" title="2"></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="kw">const</span> baseState <span class="op">=</span> <span class="op">{</span><span class="dt">users</span><span class="op">:</span> [<span class="op">{</span><span class="dt">name</span><span class="op">:</span> <span class="st">&quot;Bobby&quot;</span><span class="op">}</span>]<span class="op">}</span></a>
<a class="sourceLine" id="cb18-4" title="4"><span class="kw">const</span> nextState <span class="op">=</span> <span class="at">produce</span>(baseState<span class="op">,</span> draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-5" title="5">    <span class="at">isDraft</span>(draft) <span class="co">// =&gt; true</span></a>
<a class="sourceLine" id="cb18-6" title="6">    <span class="at">isDraft</span>(<span class="va">draft</span>.<span class="at">users</span>) <span class="co">// =&gt; true</span></a>
<a class="sourceLine" id="cb18-7" title="7">    <span class="at">isDraft</span>(<span class="va">draft</span>.<span class="at">users</span>[<span class="dv">0</span>]) <span class="co">// =&gt; true</span></a>
<a class="sourceLine" id="cb18-8" title="8"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb18-9" title="9"><span class="at">isDraft</span>(nextState) <span class="co">// =&gt; false</span></a></code></pre></div>
<h2 id="using-this">Using <code>this</code></h2>
<p>The recipe will be always invoked with the <code>draft</code> as <code>this</code> context.</p>
<p>This means that the following constructions are also valid:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb19-1" title="1"><span class="kw">const</span> base <span class="op">=</span> <span class="op">{</span><span class="dt">counter</span><span class="op">:</span> <span class="dv">0</span><span class="op">}</span></a>
<a class="sourceLine" id="cb19-2" title="2"></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="kw">const</span> next <span class="op">=</span> <span class="at">produce</span>(base<span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb19-4" title="4">    <span class="kw">this</span>.<span class="at">counter</span><span class="op">++</span></a>
<a class="sourceLine" id="cb19-5" title="5"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb19-6" title="6"><span class="va">console</span>.<span class="at">log</span>(<span class="va">next</span>.<span class="at">counter</span>) <span class="co">// 1</span></a>
<a class="sourceLine" id="cb19-7" title="7"></a>
<a class="sourceLine" id="cb19-8" title="8"><span class="co">// OR</span></a>
<a class="sourceLine" id="cb19-9" title="9"><span class="kw">const</span> increment <span class="op">=</span> <span class="at">produce</span>(<span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb19-10" title="10">    <span class="kw">this</span>.<span class="at">counter</span><span class="op">++</span></a>
<a class="sourceLine" id="cb19-11" title="11"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb19-12" title="12"><span class="va">console</span>.<span class="at">log</span>(<span class="at">increment</span>(base).<span class="at">counter</span>) <span class="co">// 1</span></a></code></pre></div>
<h2 id="inline-shortcuts-using-void">Inline shortcuts using <code>void</code></h2>
<p>Draft mutations in Immer usually warrant a code block, since a return denotes an overwrite. Sometimes that can stretch code a little more than you might be comfortable with.</p>
<p>In such cases, you can use javascripts <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/void"><code>void</code></a> operator, which evaluates expressions and returns <code>undefined</code>.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb20-1" title="1"><span class="co">// Single mutation</span></a>
<a class="sourceLine" id="cb20-2" title="2"><span class="at">produce</span>(draft <span class="kw">=&gt;</span> <span class="kw">void</span> (<span class="va">draft</span>.<span class="va">user</span>.<span class="at">age</span> <span class="op">+=</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb20-3" title="3"></a>
<a class="sourceLine" id="cb20-4" title="4"><span class="co">// Multiple mutations</span></a>
<a class="sourceLine" id="cb20-5" title="5"><span class="at">produce</span>(draft <span class="kw">=&gt;</span> <span class="kw">void</span> ((<span class="va">draft</span>.<span class="va">user</span>.<span class="at">age</span> <span class="op">+=</span> <span class="dv">1</span>)<span class="op">,</span> (<span class="va">draft</span>.<span class="va">user</span>.<span class="at">height</span> <span class="op">=</span> <span class="dv">186</span>)))</a></code></pre></div>
<p>Code style is highly personal, but for code bases that are to be understood by many, we recommend to stick to the classic <code>draft =&gt; { draft.user.age += 1}</code> to avoid cognitive overhead.</p>
<h2 id="typescript-or-flow">TypeScript or Flow</h2>
<p>The Immer package ships with type definitions inside the package, which should be picked up by TypeScript and Flow out of the box and without further configuration.</p>
<p>The TypeScript typings automatically remove <code>readonly</code> modifiers from your draft types and return a value that matches your original type. See this practical example:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode ts"><code class="sourceCode typescript"><a class="sourceLine" id="cb21-1" title="1"><span class="im">import</span> produce <span class="im">from</span> <span class="st">&quot;immer&quot;</span></a>
<a class="sourceLine" id="cb21-2" title="2"></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="kw">interface</span> State <span class="op">{</span></a>
<a class="sourceLine" id="cb21-4" title="4">    <span class="kw">readonly</span> x<span class="op">:</span> <span class="dt">number</span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="op">}</span></a>
<a class="sourceLine" id="cb21-6" title="6"></a>
<a class="sourceLine" id="cb21-7" title="7"><span class="co">// `x` cannot be modified here</span></a>
<a class="sourceLine" id="cb21-8" title="8"><span class="kw">const</span> state<span class="op">:</span> State <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb21-9" title="9">    x<span class="op">:</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb21-10" title="10"><span class="op">}</span></a>
<a class="sourceLine" id="cb21-11" title="11"></a>
<a class="sourceLine" id="cb21-12" title="12"><span class="kw">const</span> newState <span class="op">=</span> <span class="fu">produce</span><span class="op">&lt;</span>State<span class="op">&gt;</span>(state<span class="op">,</span> draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb21-13" title="13">    <span class="co">// `x` can be modified here</span></a>
<a class="sourceLine" id="cb21-14" title="14">    <span class="va">draft</span><span class="op">.</span><span class="at">x</span><span class="op">++</span></a>
<a class="sourceLine" id="cb21-15" title="15"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb21-16" title="16"></a>
<a class="sourceLine" id="cb21-17" title="17"><span class="co">// `newState.x` cannot be modified here</span></a></code></pre></div>
<p>This ensures that the only place you can modify your state is in your produce callbacks. It even works recursively and with <code>ReadonlyArray</code>s!</p>
<p><strong>Note:</strong> Immer v1.9+ supports Typescript v3.1+ only.</p>
<h2 id="immer-on-older-javascript-environments">Immer on older JavaScript environments?</h2>
<p>By default <code>produce</code> tries to use proxies for optimal performance. However, on older JavaScript engines <code>Proxy</code> is not available. For example, when running Microsoft Internet Explorer or React Native on Android. In such cases, Immer will fallback to an ES5 compatible implementation which works identical, but is a bit slower.</p>
<h2 id="importing-immer">Importing immer</h2>
<p><code>produce</code> is exposed as the default export, but optionally it can be used as name import as well, as this benefits some older project setups. So the following imports are all correct, where the first is recommended:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb22-1" title="1"><span class="im">import</span> produce <span class="im">from</span> <span class="st">&quot;immer&quot;</span></a>
<a class="sourceLine" id="cb22-2" title="2"><span class="im">import</span> <span class="op">{</span>produce<span class="op">}</span> <span class="im">from</span> <span class="st">&quot;immer&quot;</span></a>
<a class="sourceLine" id="cb22-3" title="3"></a>
<a class="sourceLine" id="cb22-4" title="4"><span class="kw">const</span> <span class="op">{</span>produce<span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;immer&quot;</span>)</a>
<a class="sourceLine" id="cb22-5" title="5"><span class="kw">const</span> produce <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;immer&quot;</span>).<span class="at">produce</span></a>
<a class="sourceLine" id="cb22-6" title="6"><span class="kw">const</span> produce <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;immer&quot;</span>).<span class="at">default</span></a>
<a class="sourceLine" id="cb22-7" title="7"></a>
<a class="sourceLine" id="cb22-8" title="8"><span class="im">import</span> unleashTheMagic <span class="im">from</span> <span class="st">&quot;immer&quot;</span></a>
<a class="sourceLine" id="cb22-9" title="9"><span class="im">import</span> <span class="op">{</span>produce <span class="im">as</span> unleashTheMagic<span class="op">}</span> <span class="im">from</span> <span class="st">&quot;immer&quot;</span></a></code></pre></div>
<h2 id="limitations">Limitations</h2>
<p>Immer supports the following types of data:</p>
<ol type="1">
<li>All kinds of primitive values</li>
<li><code>Date</code> instances, but: only if not mutated, see below</li>
<li>Arrays, but: non-standard attributes are not supported (like: <code>array.test = "Test"</code>)</li>
<li>Plain objects (objects that have as prototype either <code>null</code> or <code>Object</code>)</li>
<li>Functions, assuming they aren’t mutated</li>
<li>Other value types (like class instances) can be stored in the tree, but note that Immer won’t work <em>inside</em> those objects. In other words, if you modify a class instance, this will <em>not</em> result in clone and unmodified original, but just in a modified original.</li>
</ol>
<h1 id="pitfalls">Pitfalls</h1>
<ol type="1">
<li>Don’t redefine draft like, <code>draft = myCoolNewState</code>. Instead, either modify the <code>draft</code> or return a new state. See <a href="#returning-data-from-producers">Returning data from producers</a>.</li>
<li>Immer assumes your state to be a unidirectional tree. That is, no object should appear twice in the tree, and there should be no circular references.</li>
<li>Class instances are not, and will not have first-class support. Read <a href="https://github.com/mweststrate/immer/issues/155#issuecomment-407725592">here</a> why classes are a conceptual mismatch (and technically extremely challenging)</li>
<li>For example, working with <code>Date</code> objects is no problem, just make sure you never modify them (by using methods like <code>setYear</code> on an existing instance). Instead, always create fresh <code>Date</code> instances. Which is probably what you were unconsciously doing already.</li>
<li>Since Immer uses proxies, reading huge amounts of data from state comes with an overhead (especially in the ES5 implementation). If this ever becomes an issue (measure before you optimize!), do the current state analysis before entering the producer function or read from the <code>currentState</code> rather than the <code>draftState</code>. Also, realize that immer is opt-in everywhere, so it is perfectly fine to manually write super performance critical reducers, and use immer for all the normal ones. Also note that <code>original</code> can be used to get the original state of an object, which is cheaper to read.</li>
<li>Some debuggers (at least Node 6 is known) have trouble debugging when Proxies are in play. Node 8 is known to work correctly.</li>
<li>Always try to pull <code>produce</code> ‘up’, for example <code>for (let x of y) produce(base, d =&gt; d.push(x))</code> is exponentially slower than <code>produce(base, d =&gt; { for (let x of y) d.push(x)})</code></li>
<li>It is possible to return values from producers, except, it is not possible to return <code>undefined</code> that way, as it is indistinguishable from not updating the draft at all! If you want to replace the draft with <code>undefined</code>, just return <code>nothing</code> from the producer.</li>
<li>Immer does not support built-in data-structures like <code>Map</code> and <code>Set</code>. However, it is fine to just immutably “update” them yourself but still leverage immer wherever possible:</li>
</ol>
<div class="sourceCode" id="cb23"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb23-1" title="1"><span class="kw">const</span> state <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb23-2" title="2">    <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;hello&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb23-3" title="3">    <span class="dt">tokenSet</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Set</span>()</a>
<a class="sourceLine" id="cb23-4" title="4"><span class="op">}</span></a>
<a class="sourceLine" id="cb23-5" title="5"></a>
<a class="sourceLine" id="cb23-6" title="6"><span class="kw">const</span> nextState <span class="op">=</span> <span class="at">produce</span>(state<span class="op">,</span> draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb23-7" title="7">    <span class="va">draft</span>.<span class="at">title</span> <span class="op">=</span> <span class="va">draft</span>.<span class="va">title</span>.<span class="at">toUpperCase</span>() <span class="co">// let immer do it&#39;s job</span></a>
<a class="sourceLine" id="cb23-8" title="8">    <span class="co">// don&#39;t use the operations onSet, as that mutates the instance!</span></a>
<a class="sourceLine" id="cb23-9" title="9">    <span class="co">// draft.tokenSet.add(&quot;c1342&quot;)</span></a>
<a class="sourceLine" id="cb23-10" title="10"></a>
<a class="sourceLine" id="cb23-11" title="11">    <span class="co">// instead: clone the set (once!)</span></a>
<a class="sourceLine" id="cb23-12" title="12">    <span class="kw">const</span> newSet <span class="op">=</span> <span class="kw">new</span> <span class="at">Set</span>(<span class="va">draft</span>.<span class="at">tokenSet</span>)</a>
<a class="sourceLine" id="cb23-13" title="13">    <span class="co">// mutate the clone (just in this producer)</span></a>
<a class="sourceLine" id="cb23-14" title="14">    <span class="va">newSet</span>.<span class="at">add</span>(<span class="st">&quot;c1342&quot;</span>)</a>
<a class="sourceLine" id="cb23-15" title="15">    <span class="co">// update the draft with the new set</span></a>
<a class="sourceLine" id="cb23-16" title="16">    <span class="va">draft</span>.<span class="at">tokenSet</span> <span class="op">=</span> newSet</a>
<a class="sourceLine" id="cb23-17" title="17"><span class="op">}</span>)</a></code></pre></div>
<p>Or a deep update in maps (well, don’t use maps for this use case, but as an example):</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb24-1" title="1"><span class="kw">const</span> state <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb24-2" title="2">    <span class="dt">users</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Map</span>([<span class="st">&quot;michel&quot;</span><span class="op">,</span> <span class="op">{</span><span class="dt">name</span><span class="op">:</span> <span class="st">&quot;miche&quot;</span><span class="op">}</span>])</a>
<a class="sourceLine" id="cb24-3" title="3"><span class="op">}</span></a>
<a class="sourceLine" id="cb24-4" title="4"></a>
<a class="sourceLine" id="cb24-5" title="5"><span class="kw">const</span> nextState <span class="op">=</span> <span class="at">produce</span>(state<span class="op">,</span> draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb24-6" title="6">    <span class="kw">const</span> newUsers <span class="op">=</span> <span class="kw">new</span> <span class="at">Map</span>(<span class="va">draft</span>.<span class="at">users</span>)</a>
<a class="sourceLine" id="cb24-7" title="7">    <span class="co">// mutate the new map and set a _new_ user object</span></a>
<a class="sourceLine" id="cb24-8" title="8">    <span class="co">// but leverage produce again to base the new user object on the original one</span></a>
<a class="sourceLine" id="cb24-9" title="9">    <span class="va">newUsers</span>.<span class="at">set</span>(</a>
<a class="sourceLine" id="cb24-10" title="10">        <span class="st">&quot;michel&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb24-11" title="11">        <span class="at">produce</span>(<span class="va">draft</span>.<span class="va">users</span>.<span class="at">get</span>(<span class="st">&quot;michel&quot;</span>)<span class="op">,</span> draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb24-12" title="12">            <span class="va">draft</span>.<span class="at">name</span> <span class="op">=</span> <span class="st">&quot;michel&quot;</span></a>
<a class="sourceLine" id="cb24-13" title="13">        <span class="op">}</span>)</a>
<a class="sourceLine" id="cb24-14" title="14">    )</a>
<a class="sourceLine" id="cb24-15" title="15">    <span class="va">draft</span>.<span class="at">users</span> <span class="op">=</span> newUsers</a>
<a class="sourceLine" id="cb24-16" title="16"><span class="op">}</span>)</a></code></pre></div>
<h2 id="cool-things-built-with-immer">Cool things built with immer</h2>
<ul>
<li><a href="https://github.com/aweary/react-copy-write">react-copy-write</a> <em>Immutable state with a mutable API</em></li>
<li><a href="https://github.com/markerikson/redux-starter-kit">redux-starter-kit</a> <em>A simple set of tools to make using Redux easier</em></li>
<li><a href="https://gist.github.com/kitze/fb65f527803a93fb2803ce79a792fff8">immer based handleActions</a> <em>Boilerplate free actions for Redux</em></li>
<li><a href="https://github.com/anish000kumar/redux-box">redux-box</a> <em>Modular and easy-to-grasp redux based state management, with least boilerplate</em></li>
<li><a href="https://github.com/jeffreyyoung/quick-redux">quick-redux</a> <em>tools to make redux development quicker and easier</em></li>
<li><a href="https://github.com/jamiebuilds/bey">bey</a> <em>Simple immutable state for React using Immer</em></li>
<li><a href="https://github.com/drcmda/immer-wieder#readme">immer-wieder</a> <em>State management lib that combines React 16 Context and immer for Redux semantics</em></li>
<li><a href="https://github.com/neurosnap/robodux">robodux</a> <em>flexible way to reduce redux boilerplate</em></li>
<li><a href="https://github.com/epeli/immer-reducer">immer-reducer</a> <em>Type-safe and terse Redux reducers with Typescript</em></li>
<li>… and <a href="https://www.npmjs.com/browse/depended/immer">many more</a></li>
</ul>
<h2 id="how-does-immer-work">How does Immer work?</h2>
<p>Read the (second part of the) <a href="https://medium.com/@mweststrate/introducing-immer-immutability-the-easy-way-9d73d8f71cb3">introduction blog</a>.</p>
<h2 id="example-patterns.">Example patterns.</h2>
<p><em>For those who have to go back to thinking in object updates :-)</em></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb25-1" title="1"><span class="im">import</span> produce <span class="im">from</span> <span class="st">&quot;immer&quot;</span></a>
<a class="sourceLine" id="cb25-2" title="2"></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="co">// object mutations</span></a>
<a class="sourceLine" id="cb25-4" title="4"><span class="kw">const</span> todosObj <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb25-5" title="5">    <span class="dt">id1</span><span class="op">:</span> <span class="op">{</span><span class="dt">done</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">body</span><span class="op">:</span> <span class="st">&quot;Take out the trash&quot;</span><span class="op">},</span></a>
<a class="sourceLine" id="cb25-6" title="6">    <span class="dt">id2</span><span class="op">:</span> <span class="op">{</span><span class="dt">done</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">body</span><span class="op">:</span> <span class="st">&quot;Check Email&quot;</span><span class="op">}</span></a>
<a class="sourceLine" id="cb25-7" title="7"><span class="op">}</span></a>
<a class="sourceLine" id="cb25-8" title="8"></a>
<a class="sourceLine" id="cb25-9" title="9"><span class="co">// add</span></a>
<a class="sourceLine" id="cb25-10" title="10"><span class="kw">const</span> addedTodosObj <span class="op">=</span> <span class="at">produce</span>(todosObj<span class="op">,</span> draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb25-11" title="11">    draft[<span class="st">&quot;id3&quot;</span>] <span class="op">=</span> <span class="op">{</span><span class="dt">done</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">body</span><span class="op">:</span> <span class="st">&quot;Buy bananas&quot;</span><span class="op">}</span></a>
<a class="sourceLine" id="cb25-12" title="12"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb25-13" title="13"></a>
<a class="sourceLine" id="cb25-14" title="14"><span class="co">// delete</span></a>
<a class="sourceLine" id="cb25-15" title="15"><span class="kw">const</span> deletedTodosObj <span class="op">=</span> <span class="at">produce</span>(todosObj<span class="op">,</span> draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb25-16" title="16">    <span class="kw">delete</span> draft[<span class="st">&quot;id1&quot;</span>]</a>
<a class="sourceLine" id="cb25-17" title="17"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb25-18" title="18"></a>
<a class="sourceLine" id="cb25-19" title="19"><span class="co">// update</span></a>
<a class="sourceLine" id="cb25-20" title="20"><span class="kw">const</span> updatedTodosObj <span class="op">=</span> <span class="at">produce</span>(todosObj<span class="op">,</span> draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb25-21" title="21">    draft[<span class="st">&quot;id1&quot;</span>].<span class="at">done</span> <span class="op">=</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb25-22" title="22"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb25-23" title="23"></a>
<a class="sourceLine" id="cb25-24" title="24"><span class="co">// array mutations</span></a>
<a class="sourceLine" id="cb25-25" title="25"><span class="kw">const</span> todosArray <span class="op">=</span> [</a>
<a class="sourceLine" id="cb25-26" title="26">    <span class="op">{</span><span class="dt">id</span><span class="op">:</span> <span class="st">&quot;id1&quot;</span><span class="op">,</span> <span class="dt">done</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">body</span><span class="op">:</span> <span class="st">&quot;Take out the trash&quot;</span><span class="op">},</span></a>
<a class="sourceLine" id="cb25-27" title="27">    <span class="op">{</span><span class="dt">id</span><span class="op">:</span> <span class="st">&quot;id2&quot;</span><span class="op">,</span> <span class="dt">done</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">body</span><span class="op">:</span> <span class="st">&quot;Check Email&quot;</span><span class="op">}</span></a>
<a class="sourceLine" id="cb25-28" title="28">]</a>
<a class="sourceLine" id="cb25-29" title="29"></a>
<a class="sourceLine" id="cb25-30" title="30"><span class="co">// add</span></a>
<a class="sourceLine" id="cb25-31" title="31"><span class="kw">const</span> addedTodosArray <span class="op">=</span> <span class="at">produce</span>(todosArray<span class="op">,</span> draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb25-32" title="32">    <span class="va">draft</span>.<span class="at">push</span>(<span class="op">{</span><span class="dt">id</span><span class="op">:</span> <span class="st">&quot;id3&quot;</span><span class="op">,</span> <span class="dt">done</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">body</span><span class="op">:</span> <span class="st">&quot;Buy bananas&quot;</span><span class="op">}</span>)</a>
<a class="sourceLine" id="cb25-33" title="33"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb25-34" title="34"></a>
<a class="sourceLine" id="cb25-35" title="35"><span class="co">// delete</span></a>
<a class="sourceLine" id="cb25-36" title="36"><span class="kw">const</span> deletedTodosArray <span class="op">=</span> <span class="at">produce</span>(todosArray<span class="op">,</span> draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb25-37" title="37">    <span class="va">draft</span>.<span class="at">splice</span>(<span class="va">draft</span>.<span class="at">findIndex</span>(todo <span class="kw">=&gt;</span> <span class="va">todo</span>.<span class="at">id</span> <span class="op">===</span> <span class="st">&quot;id1&quot;</span>)<span class="op">,</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb25-38" title="38">    <span class="co">// or (slower):</span></a>
<a class="sourceLine" id="cb25-39" title="39">    <span class="co">// return draft.filter(todo =&gt; todo.id !== &quot;id1&quot;)</span></a>
<a class="sourceLine" id="cb25-40" title="40"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb25-41" title="41"></a>
<a class="sourceLine" id="cb25-42" title="42"><span class="co">// update</span></a>
<a class="sourceLine" id="cb25-43" title="43"><span class="kw">const</span> updatedTodosArray <span class="op">=</span> <span class="at">produce</span>(todosArray<span class="op">,</span> draft <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb25-44" title="44">    draft[<span class="va">draft</span>.<span class="at">findIndex</span>(todo <span class="kw">=&gt;</span> <span class="va">todo</span>.<span class="at">id</span> <span class="op">===</span> <span class="st">&quot;id1&quot;</span>)].<span class="at">done</span> <span class="op">=</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb25-45" title="45"><span class="op">}</span>)</a></code></pre></div>
<h2 id="performance">Performance</h2>
<p>Here is a <a href="__performance_tests__/todo.js">simple benchmark</a> on the performance of Immer. This test takes 50,000 todo items and updates 5,000 of them. <em>Freeze</em> indicates that the state tree has been frozen after producing it. This is a <em>development</em> best practice, as it prevents developers from accidentally modifying the state tree.</p>
<p>These tests were executed on Node 9.3.0. Use <code>yarn test:perf</code> to reproduce them locally.</p>
<figure>
<img src="images/performance.png" alt="performance.png" /><figcaption>performance.png</figcaption>
</figure>
<p>Most important observation:</p>
<ul>
<li>Immer with proxies is roughly speaking twice to three times slower as a handwritten reducer (the above test case is worst case, see <code>yarn test:perf</code> for more tests). This is in practice negligible.</li>
<li>Immer is roughly as fast as ImmutableJS. However, the <em>immutableJS + toJS</em> makes clear the cost that often needs to be paid later; converting the immutableJS objects back to plain objects, to be able to pass them to components, over the network etc… (And there is also the upfront cost of converting data received from e.g. the server to immutable JS)</li>
<li>Generating patches doesn’t significantly slow immer down</li>
<li>The ES5 fallback implementation is roughly twice as slow as the proxy implementation, in some cases worse.</li>
</ul>
<h2 id="faq">FAQ</h2>
<p><em>(for those who skimmed the above instead of actually reading)</em></p>
<p><strong>Q: Does Immer use structural sharing? So that my selectors can be memoized and such?</strong></p>
<p>A: Yes</p>
<p><strong>Q: Does Immer support deep updates?</strong></p>
<p>A: Yes</p>
<p><strong>Q: I can’t rely on Proxies being present on my target environments. Can I use Immer?</strong></p>
<p>A: Yes</p>
<p><strong>Q: Can I typecheck my data structures when using Immer?</strong></p>
<p>A: Yes</p>
<p><strong>Q: Can I store <code>Date</code> objects, functions etc in my state tree when using Immer?</strong></p>
<p>A: Yes</p>
<p><strong>Q: Is it fast?</strong></p>
<p>A: Yes</p>
<p><strong>Q: Idea! Can Immer freeze the state for me?</strong></p>
<p>A: Yes</p>
<h2 id="credits">Credits</h2>
<p>Special thanks to <span class="citation" data-cites="Mendix">@Mendix</span>, which supports its employees to experiment completely freely two full days a month, which formed the kick-start for this project.</p>
<h2 id="donations">Donations</h2>
<p>A significant part of my OSS work is unpaid. So <a href="https://mobx.js.org/donate.html">donations</a> are greatly appreciated :)</p>
</body>
</html>
