<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="cacache-npm-version-license-travis-appveyor-coverage-status">cacache <a href="https://npm.im/cacache"><img src="https://img.shields.io/npm/v/cacache.svg" alt="npm version" /></a> <a href="https://npm.im/cacache"><img src="https://img.shields.io/npm/l/cacache.svg" alt="license" /></a> <a href="https://travis-ci.org/zkat/cacache"><img src="https://img.shields.io/travis/zkat/cacache.svg" alt="Travis" /></a> <a href="https://ci.appveyor.com/project/zkat/cacache"><img src="https://ci.appveyor.com/api/projects/status/github/zkat/cacache?svg=true" alt="AppVeyor" /></a> <a href="https://coveralls.io/github/zkat/cacache?branch=latest"><img src="https://coveralls.io/repos/github/zkat/cacache/badge.svg?branch=latest" alt="Coverage Status" /></a></h1>
<p><a href="https://github.com/zkat/cacache"><code>cacache</code></a> is a Node.js library for managing local key and content address caches. It’s really fast, really good at concurrency, and it will never give you corrupted data, even if cache files get corrupted or manipulated.</p>
<p>It was originally written to be used as <a href="https://npm.im">npm</a>’s local cache, but can just as easily be used on its own.</p>
<p><em>Translations: <a href="README.es.md">español</a></em></p>
<h2 id="install">Install</h2>
<p><code>$ npm install --save cacache</code></p>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#example">Example</a></li>
<li><a href="#features">Features</a></li>
<li><a href="#contributing">Contributing</a></li>
<li><a href="#api">API</a>
<ul>
<li><a href="#localized-api">Using localized APIs</a></li>
<li>Reading
<ul>
<li><a href="#ls"><code>ls</code></a></li>
<li><a href="#ls-stream"><code>ls.stream</code></a></li>
<li><a href="#get-data"><code>get</code></a></li>
<li><a href="#get-stream"><code>get.stream</code></a></li>
<li><a href="#get-info"><code>get.info</code></a></li>
<li><a href="#get-hasContent"><code>get.hasContent</code></a></li>
</ul></li>
<li>Writing
<ul>
<li><a href="#put-data"><code>put</code></a></li>
<li><a href="#put-stream"><code>put.stream</code></a></li>
<li><a href="#put-options"><code>put*</code> opts</a></li>
<li><a href="#rm-all"><code>rm.all</code></a></li>
<li><a href="#rm-entry"><code>rm.entry</code></a></li>
<li><a href="#rm-content"><code>rm.content</code></a></li>
</ul></li>
<li>Utilities
<ul>
<li><a href="#set-locale"><code>setLocale</code></a></li>
<li><a href="#clear-memoized"><code>clearMemoized</code></a></li>
<li><a href="#tmp-mkdir"><code>tmp.mkdir</code></a></li>
<li><a href="#with-tmp"><code>tmp.withTmp</code></a></li>
</ul></li>
<li>Integrity
<ul>
<li><a href="#integrity">Subresource Integrity</a></li>
<li><a href="#verify"><code>verify</code></a></li>
<li><a href="#verify-last-run"><code>verify.lastRun</code></a></li>
</ul></li>
</ul></li>
</ul>
<h3 id="example">Example</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">const</span> cacache <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;cacache/en&#39;</span>)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;fs&#39;</span>)</a>
<a class="sourceLine" id="cb1-3" title="3"></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw">const</span> tarball <span class="op">=</span> <span class="st">&#39;/path/to/mytar.tgz&#39;</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">const</span> cachePath <span class="op">=</span> <span class="st">&#39;/tmp/my-toy-cache&#39;</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="kw">const</span> key <span class="op">=</span> <span class="st">&#39;my-unique-key-1234&#39;</span></a>
<a class="sourceLine" id="cb1-7" title="7"></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co">// Cache it! Use `cachePath` as the root of the content cache</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="va">cacache</span>.<span class="at">put</span>(cachePath<span class="op">,</span> key<span class="op">,</span> <span class="st">&#39;10293801983029384&#39;</span>).<span class="at">then</span>(integrity <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-10" title="10">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Saved content to </span><span class="sc">${</span>cachePath<span class="sc">}</span><span class="vs">.`</span>)</a>
<a class="sourceLine" id="cb1-11" title="11"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb1-12" title="12"></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="kw">const</span> destination <span class="op">=</span> <span class="st">&#39;/tmp/mytar.tgz&#39;</span></a>
<a class="sourceLine" id="cb1-14" title="14"></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="co">// Copy the contents out of the cache and into their destination!</span></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="co">// But this time, use stream instead!</span></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="va">cacache</span>.<span class="va">get</span>.<span class="at">stream</span>(</a>
<a class="sourceLine" id="cb1-18" title="18">  cachePath<span class="op">,</span> key</a>
<a class="sourceLine" id="cb1-19" title="19">).<span class="at">pipe</span>(</a>
<a class="sourceLine" id="cb1-20" title="20">  <span class="va">fs</span>.<span class="at">createWriteStream</span>(destination)</a>
<a class="sourceLine" id="cb1-21" title="21">).<span class="at">on</span>(<span class="st">&#39;finish&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-22" title="22">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;done extracting!&#39;</span>)</a>
<a class="sourceLine" id="cb1-23" title="23"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb1-24" title="24"></a>
<a class="sourceLine" id="cb1-25" title="25"><span class="co">// The same thing, but skip the key index.</span></a>
<a class="sourceLine" id="cb1-26" title="26"><span class="va">cacache</span>.<span class="va">get</span>.<span class="at">byDigest</span>(cachePath<span class="op">,</span> integrityHash).<span class="at">then</span>(data <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-27" title="27">  <span class="va">fs</span>.<span class="at">writeFile</span>(destination<span class="op">,</span> data<span class="op">,</span> err <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-28" title="28">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;tarball data fetched based on its sha512sum and written out!&#39;</span>)</a>
<a class="sourceLine" id="cb1-29" title="29">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb1-30" title="30"><span class="op">}</span>)</a></code></pre></div>
<h3 id="features">Features</h3>
<ul>
<li>Extraction by key or by content address (shasum, etc)</li>
<li><a href="#integrity">Subresource Integrity</a> web standard support</li>
<li>Multi-hash support - safely host sha1, sha512, etc, in a single cache</li>
<li>Automatic content deduplication</li>
<li>Fault tolerance (immune to corruption, partial writes, process races, etc)</li>
<li>Consistency guarantees on read and write (full data verification)</li>
<li>Lockless, high-concurrency cache access</li>
<li>Streaming support</li>
<li>Promise support</li>
<li>Pretty darn fast – sub-millisecond reads and writes including verification</li>
<li>Arbitrary metadata storage</li>
<li>Garbage collection and additional offline verification</li>
<li>Thorough test coverage</li>
<li>There’s probably a bloom filter in there somewhere. Those are cool, right? 🤔</li>
</ul>
<h3 id="contributing">Contributing</h3>
<p>The cacache team enthusiastically welcomes contributions and project participation! There’s a bunch of things you can do if you want to contribute! The <a href="CONTRIBUTING.md">Contributor Guide</a> has all the information you need for everything from reporting bugs to contributing entire new features. Please don’t hesitate to jump in if you’d like to, or even ask us questions if something isn’t clear.</p>
<p>All participants and maintainers in this project are expected to follow <a href="CODE_OF_CONDUCT.md">Code of Conduct</a>, and just generally be excellent to each other.</p>
<p>Please refer to the <a href="CHANGELOG.md">Changelog</a> for project history details, too.</p>
<p>Happy hacking!</p>
<h3 id="api">API</h3>
<h4 id="using-localized-apis"><a name="localized-api"></a> Using localized APIs</h4>
<p>cacache includes a complete API in English, with the same features as other translations. To use the English API as documented in this README, use <code>require('cacache/en')</code>. This is also currently the default if you do <code>require('cacache')</code>, but may change in the future.</p>
<p>cacache also supports other languages! You can find the list of currently supported ones by looking in <code>./locales</code> in the source directory. You can use the API in that language with <code>require('cacache/&lt;lang&gt;')</code>.</p>
<p>Want to add support for a new language? Please go ahead! You should be able to copy <code>./locales/en.js</code> and <code>./locales/en.json</code> and fill them in. Translating the <code>README.md</code> is a bit more work, but also appreciated if you get around to it. 👍🏼</p>
<h4 id="cacache.lscache---promiseobject"><a name="ls"></a> <code>&gt; cacache.ls(cache) -&gt; Promise&lt;Object&gt;</code></h4>
<p>Lists info for all entries currently in the cache as a single large object. Each entry in the object will be keyed by the unique index key, with corresponding <a href="#get-info"><code>get.info</code></a> objects as the values.</p>
<h5 id="example-1">Example</h5>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="va">cacache</span>.<span class="at">ls</span>(cachePath).<span class="at">then</span>(<span class="va">console</span>.<span class="at">log</span>)</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co">// Output</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="op">{</span></a>
<a class="sourceLine" id="cb2-4" title="4">  <span class="st">&#39;my-thing&#39;</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-5" title="5">    <span class="dt">key</span><span class="op">:</span> <span class="st">&#39;my-thing&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-6" title="6">    <span class="dt">integrity</span><span class="op">:</span> <span class="st">&#39;sha512-BaSe64/EnCoDED+HAsh==&#39;</span></a>
<a class="sourceLine" id="cb2-7" title="7">    <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;.testcache/content/deadbeef&#39;</span><span class="op">,</span> <span class="co">// joined with `cachePath`</span></a>
<a class="sourceLine" id="cb2-8" title="8">    <span class="dt">time</span><span class="op">:</span> <span class="dv">12345698490</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-9" title="9">    <span class="dt">size</span><span class="op">:</span> <span class="dv">4023948</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-10" title="10">    <span class="dt">metadata</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-11" title="11">      <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;blah&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-12" title="12">      <span class="dt">version</span><span class="op">:</span> <span class="st">&#39;1.2.3&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-13" title="13">      <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;this was once a package but now it is my-thing&#39;</span></a>
<a class="sourceLine" id="cb2-14" title="14">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-15" title="15">  <span class="op">},</span></a>
<a class="sourceLine" id="cb2-16" title="16">  <span class="st">&#39;other-thing&#39;</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-17" title="17">    <span class="dt">key</span><span class="op">:</span> <span class="st">&#39;other-thing&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-18" title="18">    <span class="dt">integrity</span><span class="op">:</span> <span class="st">&#39;sha1-ANothER+hasH=&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-19" title="19">    <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;.testcache/content/bada55&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-20" title="20">    <span class="dt">time</span><span class="op">:</span> <span class="dv">11992309289</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-21" title="21">    <span class="dt">size</span><span class="op">:</span> <span class="dv">111112</span></a>
<a class="sourceLine" id="cb2-22" title="22">  <span class="op">}</span></a>
<a class="sourceLine" id="cb2-23" title="23"><span class="op">}</span></a></code></pre></div>
<h4 id="cacache.ls.streamcache---readable"><a name="ls-stream"></a> <code>&gt; cacache.ls.stream(cache) -&gt; Readable</code></h4>
<p>Lists info for all entries currently in the cache as a single large object.</p>
<p>This works just like <a href="#ls"><code>ls</code></a>, except <a href="#get-info"><code>get.info</code></a> entries are returned as <code>'data'</code> events on the returned stream.</p>
<h5 id="example-2">Example</h5>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="va">cacache</span>.<span class="va">ls</span>.<span class="at">stream</span>(cachePath).<span class="at">on</span>(<span class="st">&#39;data&#39;</span><span class="op">,</span> <span class="va">console</span>.<span class="at">log</span>)</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="co">// Output</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="op">{</span></a>
<a class="sourceLine" id="cb3-4" title="4">  <span class="dt">key</span><span class="op">:</span> <span class="st">&#39;my-thing&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-5" title="5">  <span class="dt">integrity</span><span class="op">:</span> <span class="st">&#39;sha512-BaSe64HaSh&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-6" title="6">  <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;.testcache/content/deadbeef&#39;</span><span class="op">,</span> <span class="co">// joined with `cachePath`</span></a>
<a class="sourceLine" id="cb3-7" title="7">  <span class="dt">time</span><span class="op">:</span> <span class="dv">12345698490</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-8" title="8">  <span class="dt">size</span><span class="op">:</span> <span class="dv">13423</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-9" title="9">  <span class="dt">metadata</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-10" title="10">    <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;blah&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-11" title="11">    <span class="dt">version</span><span class="op">:</span> <span class="st">&#39;1.2.3&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-12" title="12">    <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;this was once a package but now it is my-thing&#39;</span></a>
<a class="sourceLine" id="cb3-13" title="13">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-14" title="14"><span class="op">}</span></a>
<a class="sourceLine" id="cb3-15" title="15"></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="op">{</span></a>
<a class="sourceLine" id="cb3-17" title="17">  <span class="dt">key</span><span class="op">:</span> <span class="st">&#39;other-thing&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-18" title="18">  <span class="dt">integrity</span><span class="op">:</span> <span class="st">&#39;whirlpool-WoWSoMuchSupport&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-19" title="19">  <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;.testcache/content/bada55&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-20" title="20">  <span class="dt">time</span><span class="op">:</span> <span class="dv">11992309289</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-21" title="21">  <span class="dt">size</span><span class="op">:</span> <span class="dv">498023984029</span></a>
<a class="sourceLine" id="cb3-22" title="22"><span class="op">}</span></a>
<a class="sourceLine" id="cb3-23" title="23"></a>
<a class="sourceLine" id="cb3-24" title="24"><span class="op">{</span></a>
<a class="sourceLine" id="cb3-25" title="25">  ...</a>
<a class="sourceLine" id="cb3-26" title="26"><span class="op">}</span></a></code></pre></div>
<h4 id="cacache.getcache-key-opts---promisedata-metadata-integrity"><a name="get-data"></a> <code>&gt; cacache.get(cache, key, [opts]) -&gt; Promise({data, metadata, integrity})</code></h4>
<p>Returns an object with the cached data, digest, and metadata identified by <code>key</code>. The <code>data</code> property of this object will be a <code>Buffer</code> instance that presumably holds some data that means something to you. I’m sure you know what to do with it! cacache just won’t care.</p>
<p><code>integrity</code> is a <a href="#integrity">Subresource Integrity</a> string. That is, a string that can be used to verify <code>data</code>, which looks like <code>&lt;hash-algorithm&gt;-&lt;base64-integrity-hash&gt;</code>.</p>
<p>If there is no content identified by <code>key</code>, or if the locally-stored data does not pass the validity checksum, the promise will be rejected.</p>
<p>A sub-function, <code>get.byDigest</code> may be used for identical behavior, except lookup will happen by integrity hash, bypassing the index entirely. This version of the function <em>only</em> returns <code>data</code> itself, without any wrapper.</p>
<h5 id="note">Note</h5>
<p>This function loads the entire cache entry into memory before returning it. If you’re dealing with Very Large data, consider using <a href="#get-stream"><code>get.stream</code></a> instead.</p>
<h5 id="example-3">Example</h5>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="co">// Look up by key</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="va">cache</span>.<span class="at">get</span>(cachePath<span class="op">,</span> <span class="st">&#39;my-thing&#39;</span>).<span class="at">then</span>(<span class="va">console</span>.<span class="at">log</span>)</a>
<a class="sourceLine" id="cb4-3" title="3"><span class="co">// Output:</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="op">{</span></a>
<a class="sourceLine" id="cb4-5" title="5">  <span class="dt">metadata</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-6" title="6">    <span class="dt">thingName</span><span class="op">:</span> <span class="st">&#39;my&#39;</span></a>
<a class="sourceLine" id="cb4-7" title="7">  <span class="op">},</span></a>
<a class="sourceLine" id="cb4-8" title="8">  <span class="dt">integrity</span><span class="op">:</span> <span class="st">&#39;sha512-BaSe64HaSh&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb4-9" title="9">  <span class="dt">data</span><span class="op">:</span> Buffer#<span class="op">&lt;</span>deadbeef<span class="op">&gt;,</span></a>
<a class="sourceLine" id="cb4-10" title="10">  <span class="dt">size</span><span class="op">:</span> <span class="dv">9320</span></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="op">}</span></a>
<a class="sourceLine" id="cb4-12" title="12"></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="co">// Look up by digest</span></a>
<a class="sourceLine" id="cb4-14" title="14"><span class="va">cache</span>.<span class="va">get</span>.<span class="at">byDigest</span>(cachePath<span class="op">,</span> <span class="st">&#39;sha512-BaSe64HaSh&#39;</span>).<span class="at">then</span>(<span class="va">console</span>.<span class="at">log</span>)</a>
<a class="sourceLine" id="cb4-15" title="15"><span class="co">// Output:</span></a>
<a class="sourceLine" id="cb4-16" title="16">Buffer#<span class="op">&lt;</span>deadbeef<span class="op">&gt;</span></a></code></pre></div>
<h4 id="cacache.get.streamcache-key-opts---readable"><a name="get-stream"></a> <code>&gt; cacache.get.stream(cache, key, [opts]) -&gt; Readable</code></h4>
<p>Returns a <a href="https://nodejs.org/api/stream.html#stream_readable_streams">Readable Stream</a> of the cached data identified by <code>key</code>.</p>
<p>If there is no content identified by <code>key</code>, or if the locally-stored data does not pass the validity checksum, an error will be emitted.</p>
<p><code>metadata</code> and <code>integrity</code> events will be emitted before the stream closes, if you need to collect that extra data about the cached entry.</p>
<p>A sub-function, <code>get.stream.byDigest</code> may be used for identical behavior, except lookup will happen by integrity hash, bypassing the index entirely. This version does not emit the <code>metadata</code> and <code>integrity</code> events at all.</p>
<h5 id="example-4">Example</h5>
<div class="sourceCode" id="cb5"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="co">// Look up by key</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="va">cache</span>.<span class="va">get</span>.<span class="at">stream</span>(</a>
<a class="sourceLine" id="cb5-3" title="3">  cachePath<span class="op">,</span> <span class="st">&#39;my-thing&#39;</span></a>
<a class="sourceLine" id="cb5-4" title="4">).<span class="at">on</span>(<span class="st">&#39;metadata&#39;</span><span class="op">,</span> metadata <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-5" title="5">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;metadata:&#39;</span><span class="op">,</span> metadata)</a>
<a class="sourceLine" id="cb5-6" title="6"><span class="op">}</span>).<span class="at">on</span>(<span class="st">&#39;integrity&#39;</span><span class="op">,</span> integrity <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-7" title="7">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;integrity:&#39;</span><span class="op">,</span> integrity)</a>
<a class="sourceLine" id="cb5-8" title="8"><span class="op">}</span>).<span class="at">pipe</span>(</a>
<a class="sourceLine" id="cb5-9" title="9">  <span class="va">fs</span>.<span class="at">createWriteStream</span>(<span class="st">&#39;./x.tgz&#39;</span>)</a>
<a class="sourceLine" id="cb5-10" title="10">)</a>
<a class="sourceLine" id="cb5-11" title="11"><span class="co">// Outputs:</span></a>
<a class="sourceLine" id="cb5-12" title="12">metadata<span class="op">:</span> <span class="op">{</span> ... <span class="op">}</span></a>
<a class="sourceLine" id="cb5-13" title="13">integrity<span class="op">:</span> <span class="st">&#39;sha512-SoMeDIGest+64==&#39;</span></a>
<a class="sourceLine" id="cb5-14" title="14"></a>
<a class="sourceLine" id="cb5-15" title="15"><span class="co">// Look up by digest</span></a>
<a class="sourceLine" id="cb5-16" title="16"><span class="va">cache</span>.<span class="va">get</span>.<span class="va">stream</span>.<span class="at">byDigest</span>(</a>
<a class="sourceLine" id="cb5-17" title="17">  cachePath<span class="op">,</span> <span class="st">&#39;sha512-SoMeDIGest+64==&#39;</span></a>
<a class="sourceLine" id="cb5-18" title="18">).<span class="at">pipe</span>(</a>
<a class="sourceLine" id="cb5-19" title="19">  <span class="va">fs</span>.<span class="at">createWriteStream</span>(<span class="st">&#39;./x.tgz&#39;</span>)</a>
<a class="sourceLine" id="cb5-20" title="20">)</a></code></pre></div>
<h4 id="cacache.get.infocache-key---promise"><a name="get-info"></a> <code>&gt; cacache.get.info(cache, key) -&gt; Promise</code></h4>
<p>Looks up <code>key</code> in the cache index, returning information about the entry if one exists.</p>
<h5 id="fields">Fields</h5>
<ul>
<li><code>key</code> - Key the entry was looked up under. Matches the <code>key</code> argument.</li>
<li><code>integrity</code> - <a href="#integrity">Subresource Integrity hash</a> for the content this entry refers to.</li>
<li><code>path</code> - Filesystem path where content is stored, joined with <code>cache</code> argument.</li>
<li><code>time</code> - Timestamp the entry was first added on.</li>
<li><code>metadata</code> - User-assigned metadata associated with the entry/content.</li>
</ul>
<h5 id="example-5">Example</h5>
<div class="sourceCode" id="cb6"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="va">cacache</span>.<span class="va">get</span>.<span class="at">info</span>(cachePath<span class="op">,</span> <span class="st">&#39;my-thing&#39;</span>).<span class="at">then</span>(<span class="va">console</span>.<span class="at">log</span>)</a>
<a class="sourceLine" id="cb6-2" title="2"></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co">// Output</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="op">{</span></a>
<a class="sourceLine" id="cb6-5" title="5">  <span class="dt">key</span><span class="op">:</span> <span class="st">&#39;my-thing&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-6" title="6">  <span class="dt">integrity</span><span class="op">:</span> <span class="st">&#39;sha256-MUSTVERIFY+ALL/THINGS==&#39;</span></a>
<a class="sourceLine" id="cb6-7" title="7">  <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;.testcache/content/deadbeef&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-8" title="8">  <span class="dt">time</span><span class="op">:</span> <span class="dv">12345698490</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-9" title="9">  <span class="dt">size</span><span class="op">:</span> <span class="dv">849234</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-10" title="10">  <span class="dt">metadata</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-11" title="11">    <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;blah&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-12" title="12">    <span class="dt">version</span><span class="op">:</span> <span class="st">&#39;1.2.3&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-13" title="13">    <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;this was once a package but now it is my-thing&#39;</span></a>
<a class="sourceLine" id="cb6-14" title="14">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-15" title="15"><span class="op">}</span></a></code></pre></div>
<h4 id="cacache.get.hascontentcache-integrity---promise"><a name="get-hasContent"></a> <code>&gt; cacache.get.hasContent(cache, integrity) -&gt; Promise</code></h4>
<p>Looks up a <a href="#integrity">Subresource Integrity hash</a> in the cache. If content exists for this <code>integrity</code>, it will return an object, with the specific single integrity hash that was found in <code>sri</code> key, and the size of the found content as <code>size</code>. If no content exists for this integrity, it will return <code>false</code>.</p>
<h5 id="example-6">Example</h5>
<div class="sourceCode" id="cb7"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="va">cacache</span>.<span class="va">get</span>.<span class="at">hasContent</span>(cachePath<span class="op">,</span> <span class="st">&#39;sha256-MUSTVERIFY+ALL/THINGS==&#39;</span>).<span class="at">then</span>(<span class="va">console</span>.<span class="at">log</span>)</a>
<a class="sourceLine" id="cb7-2" title="2"></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="co">// Output</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="op">{</span></a>
<a class="sourceLine" id="cb7-5" title="5">  <span class="dt">sri</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-6" title="6">    <span class="dt">source</span><span class="op">:</span> <span class="st">&#39;sha256-MUSTVERIFY+ALL/THINGS==&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb7-7" title="7">    <span class="dt">algorithm</span><span class="op">:</span> <span class="st">&#39;sha256&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb7-8" title="8">    <span class="dt">digest</span><span class="op">:</span> <span class="st">&#39;MUSTVERIFY+ALL/THINGS==&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb7-9" title="9">    <span class="dt">options</span><span class="op">:</span> []</a>
<a class="sourceLine" id="cb7-10" title="10">  <span class="op">},</span></a>
<a class="sourceLine" id="cb7-11" title="11">  <span class="dt">size</span><span class="op">:</span> <span class="dv">9001</span></a>
<a class="sourceLine" id="cb7-12" title="12"><span class="op">}</span></a>
<a class="sourceLine" id="cb7-13" title="13"></a>
<a class="sourceLine" id="cb7-14" title="14"><span class="va">cacache</span>.<span class="va">get</span>.<span class="at">hasContent</span>(cachePath<span class="op">,</span> <span class="st">&#39;sha521-NOT+IN/CACHE==&#39;</span>).<span class="at">then</span>(<span class="va">console</span>.<span class="at">log</span>)</a>
<a class="sourceLine" id="cb7-15" title="15"></a>
<a class="sourceLine" id="cb7-16" title="16"><span class="co">// Output</span></a>
<a class="sourceLine" id="cb7-17" title="17"><span class="kw">false</span></a></code></pre></div>
<h4 id="cacache.putcache-key-data-opts---promise"><a name="put-data"></a> <code>&gt; cacache.put(cache, key, data, [opts]) -&gt; Promise</code></h4>
<p>Inserts data passed to it into the cache. The returned Promise resolves with a digest (generated according to <a href="#optsalgorithms"><code>opts.algorithms</code></a>) after the cache entry has been successfully written.</p>
<h5 id="example-7">Example</h5>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="at">fetch</span>(</a>
<a class="sourceLine" id="cb8-2" title="2">  <span class="st">&#39;https://registry.npmjs.org/cacache/-/cacache-1.0.0.tgz&#39;</span></a>
<a class="sourceLine" id="cb8-3" title="3">).<span class="at">then</span>(data <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-4" title="4">  <span class="cf">return</span> <span class="va">cacache</span>.<span class="at">put</span>(cachePath<span class="op">,</span> <span class="st">&#39;registry.npmjs.org|cacache@1.0.0&#39;</span><span class="op">,</span> data)</a>
<a class="sourceLine" id="cb8-5" title="5"><span class="op">}</span>).<span class="at">then</span>(integrity <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-6" title="6">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;integrity hash is&#39;</span><span class="op">,</span> integrity)</a>
<a class="sourceLine" id="cb8-7" title="7"><span class="op">}</span>)</a></code></pre></div>
<h4 id="cacache.put.streamcache-key-opts---writable"><a name="put-stream"></a> <code>&gt; cacache.put.stream(cache, key, [opts]) -&gt; Writable</code></h4>
<p>Returns a <a href="https://nodejs.org/api/stream.html#stream_writable_streams">Writable Stream</a> that inserts data written to it into the cache. Emits an <code>integrity</code> event with the digest of written contents when it succeeds.</p>
<h5 id="example-8">Example</h5>
<div class="sourceCode" id="cb9"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="va">request</span>.<span class="at">get</span>(</a>
<a class="sourceLine" id="cb9-2" title="2">  <span class="st">&#39;https://registry.npmjs.org/cacache/-/cacache-1.0.0.tgz&#39;</span></a>
<a class="sourceLine" id="cb9-3" title="3">).<span class="at">pipe</span>(</a>
<a class="sourceLine" id="cb9-4" title="4">  <span class="va">cacache</span>.<span class="va">put</span>.<span class="at">stream</span>(</a>
<a class="sourceLine" id="cb9-5" title="5">    cachePath<span class="op">,</span> <span class="st">&#39;registry.npmjs.org|cacache@1.0.0&#39;</span></a>
<a class="sourceLine" id="cb9-6" title="6">  ).<span class="at">on</span>(<span class="st">&#39;integrity&#39;</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`integrity digest is </span><span class="sc">${</span>d<span class="sc">}</span><span class="vs">`</span>))</a>
<a class="sourceLine" id="cb9-7" title="7">)</a></code></pre></div>
<h4 id="cacache.put-options"><a name="put-options"></a> <code>&gt; cacache.put options</code></h4>
<p><code>cacache.put</code> functions have a number of options in common.</p>
<h5 id="opts.metadata"><code>opts.metadata</code></h5>
<p>Arbitrary metadata to be attached to the inserted key.</p>
<h5 id="opts.size"><code>opts.size</code></h5>
<p>If provided, the data stream will be verified to check that enough data was passed through. If there’s more or less data than expected, insertion will fail with an <code>EBADSIZE</code> error.</p>
<h5 id="opts.integrity"><code>opts.integrity</code></h5>
<p>If present, the pre-calculated digest for the inserted content. If this option if provided and does not match the post-insertion digest, insertion will fail with an <code>EINTEGRITY</code> error.</p>
<p><code>algorithms</code> has no effect if this option is present.</p>
<h5 id="opts.algorithms"><code>opts.algorithms</code></h5>
<p>Default: [‘sha512’]</p>
<p>Hashing algorithms to use when calculating the <a href="#integrity">subresource integrity digest</a> for inserted data. Can use any algorithm listed in <code>crypto.getHashes()</code> or <code>'omakase'</code>/<code>'お任せします'</code> to pick a random hash algorithm on each insertion. You may also use any anagram of <code>'modnar'</code> to use this feature.</p>
<p>Currently only supports one algorithm at a time (i.e., an array length of exactly <code>1</code>). Has no effect if <code>opts.integrity</code> is present.</p>
<h5 id="opts.uidopts.gid"><code>opts.uid</code>/<code>opts.gid</code></h5>
<p>If provided, cacache will do its best to make sure any new files added to the cache use this particular <code>uid</code>/<code>gid</code> combination. This can be used, for example, to drop permissions when someone uses <code>sudo</code>, but cacache makes no assumptions about your needs here.</p>
<h5 id="opts.memoize"><code>opts.memoize</code></h5>
<p>Default: null</p>
<p>If provided, cacache will memoize the given cache insertion in memory, bypassing any filesystem checks for that key or digest in future cache fetches. Nothing will be written to the in-memory cache unless this option is explicitly truthy.</p>
<p>If <code>opts.memoize</code> is an object or a <code>Map</code>-like (that is, an object with <code>get</code> and <code>set</code> methods), it will be written to instead of the global memoization cache.</p>
<p>Reading from disk data can be forced by explicitly passing <code>memoize: false</code> to the reader functions, but their default will be to read from memory.</p>
<h4 id="cacache.rm.allcache---promise"><a name="rm-all"></a> <code>&gt; cacache.rm.all(cache) -&gt; Promise</code></h4>
<p>Clears the entire cache. Mainly by blowing away the cache directory itself.</p>
<h5 id="example-9">Example</h5>
<div class="sourceCode" id="cb10"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="va">cacache</span>.<span class="va">rm</span>.<span class="at">all</span>(cachePath).<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;THE APOCALYPSE IS UPON US 😱&#39;</span>)</a>
<a class="sourceLine" id="cb10-3" title="3"><span class="op">}</span>)</a></code></pre></div>
<h4 id="cacache.rm.entrycache-key---promise"><a name="rm-entry"></a> <code>&gt; cacache.rm.entry(cache, key) -&gt; Promise</code></h4>
<p>Alias: <code>cacache.rm</code></p>
<p>Removes the index entry for <code>key</code>. Content will still be accessible if requested directly by content address (<a href="#get-stream"><code>get.stream.byDigest</code></a>).</p>
<p>To remove the content itself (which might still be used by other entries), use <a href="#rm-content"><code>rm.content</code></a>. Or, to safely vacuum any unused content, use <a href="#verify"><code>verify</code></a>.</p>
<h5 id="example-10">Example</h5>
<div class="sourceCode" id="cb11"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" title="1"><span class="va">cacache</span>.<span class="va">rm</span>.<span class="at">entry</span>(cachePath<span class="op">,</span> <span class="st">&#39;my-thing&#39;</span>).<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;I did not like it anyway&#39;</span>)</a>
<a class="sourceLine" id="cb11-3" title="3"><span class="op">}</span>)</a></code></pre></div>
<h4 id="cacache.rm.contentcache-integrity---promise"><a name="rm-content"></a> <code>&gt; cacache.rm.content(cache, integrity) -&gt; Promise</code></h4>
<p>Removes the content identified by <code>integrity</code>. Any index entries referring to it will not be usable again until the content is re-added to the cache with an identical digest.</p>
<h5 id="example-11">Example</h5>
<div class="sourceCode" id="cb12"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb12-1" title="1"><span class="va">cacache</span>.<span class="va">rm</span>.<span class="at">content</span>(cachePath<span class="op">,</span> <span class="st">&#39;sha512-SoMeDIGest/IN+BaSE64==&#39;</span>).<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;data for my-thing is gone!&#39;</span>)</a>
<a class="sourceLine" id="cb12-3" title="3"><span class="op">}</span>)</a></code></pre></div>
<h4 id="cacache.setlocalelocale"><a name="set-locale"></a> <code>&gt; cacache.setLocale(locale)</code></h4>
<p>Configure the language/locale used for messages and errors coming from cacache. The list of available locales is in the <code>./locales</code> directory in the project root.</p>
<p><em>Interested in contributing more languages! <a href="CONTRIBUTING.md">Submit a PR</a>!</em></p>
<h4 id="cacache.clearmemoized"><a name="clear-memoized"></a> <code>&gt; cacache.clearMemoized()</code></h4>
<p>Completely resets the in-memory entry cache.</p>
<h4 id="tmp.mkdircache-opts---promisepath"><a name="tmp-mkdir"></a> <code>&gt; tmp.mkdir(cache, opts) -&gt; Promise&lt;Path&gt;</code></h4>
<p>Returns a unique temporary directory inside the cache’s <code>tmp</code> dir. This directory will use the same safe user assignment that all the other stuff use.</p>
<p>Once the directory is made, it’s the user’s responsibility that all files within are made according to the same <code>opts.gid</code>/<code>opts.uid</code> settings that would be passed in. If not, you can ask cacache to do it for you by calling <a href="#tmp-fix"><code>tmp.fix()</code></a>, which will fix all tmp directory permissions.</p>
<p>If you want automatic cleanup of this directory, use <a href="#with-tpm"><code>tmp.withTmp()</code></a></p>
<h5 id="example-12">Example</h5>
<div class="sourceCode" id="cb13"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" title="1"><span class="va">cacache</span>.<span class="va">tmp</span>.<span class="at">mkdir</span>(cache).<span class="at">then</span>(dir <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="va">fs</span>.<span class="at">writeFile</span>(<span class="va">path</span>.<span class="at">join</span>(dir<span class="op">,</span> <span class="st">&#39;blablabla&#39;</span>)<span class="op">,</span> Buffer#<span class="op">&lt;</span><span class="dv">1234</span><span class="op">&gt;,</span> ...)</a>
<a class="sourceLine" id="cb13-3" title="3"><span class="op">}</span>)</a></code></pre></div>
<h4 id="tmp.withtmpcache-opts-cb---promise"><a name="with-tmp"></a> <code>&gt; tmp.withTmp(cache, opts, cb) -&gt; Promise</code></h4>
<p>Creates a temporary directory with <a href="#tmp-mkdir"><code>tmp.mkdir()</code></a> and calls <code>cb</code> with it. The created temporary directory will be removed when the return value of <code>cb()</code> resolves – that is, if you return a Promise from <code>cb()</code>, the tmp directory will be automatically deleted once that promise completes.</p>
<p>The same caveats apply when it comes to managing permissions for the tmp dir’s contents.</p>
<h5 id="example-13">Example</h5>
<div class="sourceCode" id="cb14"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb14-1" title="1"><span class="va">cacache</span>.<span class="va">tmp</span>.<span class="at">withTmp</span>(cache<span class="op">,</span> dir <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="cf">return</span> <span class="va">fs</span>.<span class="at">writeFileAsync</span>(<span class="va">path</span>.<span class="at">join</span>(dir<span class="op">,</span> <span class="st">&#39;blablabla&#39;</span>)<span class="op">,</span> Buffer#<span class="op">&lt;</span><span class="dv">1234</span><span class="op">&gt;,</span> ...)</a>
<a class="sourceLine" id="cb14-3" title="3"><span class="op">}</span>).<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-4" title="4">  <span class="co">// `dir` no longer exists</span></a>
<a class="sourceLine" id="cb14-5" title="5"><span class="op">}</span>)</a></code></pre></div>
<h4 id="subresource-integrity-digests"><a name="integrity"></a> Subresource Integrity Digests</h4>
<p>For content verification and addressing, cacache uses strings following the <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity">Subresource Integrity spec</a>. That is, any time cacache expects an <code>integrity</code> argument or option, it should be in the format <code>&lt;hashAlgorithm&gt;-&lt;base64-hash&gt;</code>.</p>
<p>One deviation from the current spec is that cacache will support any hash algorithms supported by the underlying Node.js process. You can use <code>crypto.getHashes()</code> to see which ones you can use.</p>
<h5 id="generating-digests-yourself">Generating Digests Yourself</h5>
<p>If you have an existing content shasum, they are generally formatted as a hexadecimal string (that is, a sha1 would look like: <code>5f5513f8822fdbe5145af33b64d8d970dcf95c6e</code>). In order to be compatible with cacache, you’ll need to convert this to an equivalent subresource integrity string. For this example, the corresponding hash would be: <code>sha1-X1UT+IIv2+UUWvM7ZNjZcNz5XG4=</code>.</p>
<p>If you want to generate an integrity string yourself for existing data, you can use something like this:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">const</span> crypto <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;crypto&#39;</span>)</a>
<a class="sourceLine" id="cb15-2" title="2"><span class="kw">const</span> hashAlgorithm <span class="op">=</span> <span class="st">&#39;sha512&#39;</span></a>
<a class="sourceLine" id="cb15-3" title="3"><span class="kw">const</span> data <span class="op">=</span> <span class="st">&#39;foobarbaz&#39;</span></a>
<a class="sourceLine" id="cb15-4" title="4"></a>
<a class="sourceLine" id="cb15-5" title="5"><span class="kw">const</span> integrity <span class="op">=</span> (</a>
<a class="sourceLine" id="cb15-6" title="6">  hashAlgorithm <span class="op">+</span></a>
<a class="sourceLine" id="cb15-7" title="7">  <span class="st">&#39;-&#39;</span> <span class="op">+</span></a>
<a class="sourceLine" id="cb15-8" title="8">  <span class="va">crypto</span>.<span class="at">createHash</span>(hashAlgorithm).<span class="at">update</span>(data).<span class="at">digest</span>(<span class="st">&#39;base64&#39;</span>)</a>
<a class="sourceLine" id="cb15-9" title="9">)</a></code></pre></div>
<p>You can also use <a href="https://npm.im/ssri"><code>ssri</code></a> to have a richer set of functionality around SRI strings, including generation, parsing, and translating from existing hex-formatted strings.</p>
<h4 id="cacache.verifycache-opts---promise"><a name="verify"></a> <code>&gt; cacache.verify(cache, opts) -&gt; Promise</code></h4>
<p>Checks out and fixes up your cache:</p>
<ul>
<li>Cleans up corrupted or invalid index entries.</li>
<li>Custom entry filtering options.</li>
<li>Garbage collects any content entries not referenced by the index.</li>
<li>Checks integrity for all content entries and removes invalid content.</li>
<li>Fixes cache ownership.</li>
<li>Removes the <code>tmp</code> directory in the cache and all its contents.</li>
</ul>
<p>When it’s done, it’ll return an object with various stats about the verification process, including amount of storage reclaimed, number of valid entries, number of entries removed, etc.</p>
<h5 id="options">Options</h5>
<ul>
<li><code>opts.uid</code> - uid to assign to cache and its contents</li>
<li><code>opts.gid</code> - gid to assign to cache and its contents</li>
<li><code>opts.filter</code> - receives a formatted entry. Return false to remove it. Note: might be called more than once on the same entry.</li>
</ul>
<h5 id="example-14">Example</h5>
<div class="sourceCode" id="cb16"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb16-1" title="1"><span class="bu">echo</span> somegarbage <span class="op">&gt;&gt;</span> <span class="va">$CACHEPATH</span>/content/deadbeef</a></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb17-1" title="1"><span class="va">cacache</span>.<span class="at">verify</span>(cachePath).<span class="at">then</span>(stats <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb17-2" title="2">  <span class="co">// deadbeef collected, because of invalid checksum.</span></a>
<a class="sourceLine" id="cb17-3" title="3">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;cache is much nicer now! stats:&#39;</span><span class="op">,</span> stats)</a>
<a class="sourceLine" id="cb17-4" title="4"><span class="op">}</span>)</a></code></pre></div>
<h4 id="cacache.verify.lastruncache---promise"><a name="verify-last-run"></a> <code>&gt; cacache.verify.lastRun(cache) -&gt; Promise</code></h4>
<p>Returns a <code>Date</code> representing the last time <code>cacache.verify</code> was run on <code>cache</code>.</p>
<h5 id="example-15">Example</h5>
<div class="sourceCode" id="cb18"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb18-1" title="1"><span class="va">cacache</span>.<span class="at">verify</span>(cachePath).<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-2" title="2">  <span class="va">cacache</span>.<span class="va">verify</span>.<span class="at">lastRun</span>(cachePath).<span class="at">then</span>(lastTime <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-3" title="3">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;cacache.verify was last called on&#39;</span> <span class="op">+</span> lastTime)</a>
<a class="sourceLine" id="cb18-4" title="4">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb18-5" title="5"><span class="op">}</span>)</a></code></pre></div>
</body>
</html>
